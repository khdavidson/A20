---
title: "San Juan escapement 2023 (PRELIM)"
author: "South Coast StA"
date: "Last update: `r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
knit: (function(inputFile, encoding) { 
  rmarkdown::render(inputFile, encoding=encoding, output_file=paste0(substr(inputFile,1,nchar(inputFile)-4), "_PRELIMINARY_", format(Sys.Date(), sep="_", "%Y-%m-%d"), '.html')) 
  }
  )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, message=F)

# Load libraries ----------------------------
library(tidyverse)
library(readxl)
library(here)
library(ggpubr)        # for ggarrange()
library(kableExtra)    # for kbl()
library(tidytext)      # for reorder_within()


# Helpers ----------------------------
analysis_year <- 2023



# ============================= Load data ============================

# SILS ----------------------------
sj.sil <- readxl::read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/2023/SILs/Area 20/A20_Port_Renfrew_2023.xlsx", sheet="Port Renfrew raw SIL entry", guess_max=20000) %>%
  filter(system=="San Juan") %>% 
  mutate_at(c("SIL page", "page_rowref"), as.integer) %>%
  mutate(`SIL page` = round(`SIL page`,0)) %>%
  arrange(desc(segment))  %>% 
  print()

tribs.sil <- readxl::read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/2023/SILs/Area 20/A20_Port_Renfrew_2023.xlsx", sheet="Port Renfrew raw SIL entry", guess_max=20000) %>%
  filter(system!="San Juan") %>%
  mutate_at("SIL page", as.numeric) %>%
  print()


# Hatchery ----------------------------
mile4.fence <- readxl::read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/San_Juan_Fence_2022-present.xlsx", sheet="Sheet1", guess_max=20000) %>%
  filter(year==analysis_year) %>% 
  print()


# Enviro ----------------------------
sj.water <- list.files(here::here("data", "enviro"), pattern = "08HA010", full.names = T) %>% 
  map(~read.csv(file=.x, skip=9)) %>%
  purrr::list_rbind() %>%
  mutate(date = as.Date(Date..PST.),
         Parameter = case_when(Parameter==46~"water level",
                               Parameter==47 ~ "discharge")) %>%
  rename(level_m = Value.m.,
         cms = Value.m..s.) %>%
  print()
```

<br>

<br>


# **Chinook** 

Six snorkel surveys and one helicopter survey were conducted for Chinook in 2023. 

<br>

## Counts & environmentals

```{r }
ggplot() +
  geom_ribbon(data=sj.water %>% group_by(date) %>% summarize(minL=min(level_m,na.rm=T), maxL=max(level_m,na.rm=T), 
                                                             minD=min(cms,na.rm=T), maxD=max(cms,na.rm=T)) %>% filter(across(c(minL:maxD), ~.!="Inf")), 
              aes(x=as.Date(date), ymin=minD*5, ymax=maxD*5), fill="dodger blue", alpha=0.5) +
  geom_line(data=sj.water %>% group_by(date) %>% summarize(meanL = mean(level_m,na.rm=T),
                                                           meanD = mean(cms,na.rm=T)) %>% filter(across(c(meanL:meanD), ~.!="Inf")), 
            aes(x=as.Date(date), y=meanD*5), colour="dodger blue") +
  geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
             summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
           aes(x=as.Date(date), y=n, fill=section, colour=section), 
           stat="identity", position="stack", alpha=0.7) +
  # geom_point(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
  #              summarize(n=sum(`adults dead`)), 
  #            aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
  # geom_line(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
  #             summarize(n=sum(`adults dead`)), 
  #           aes(x=as.Date(date), y=n), 
  #           stat="identity", position="stack") +
  labs(x="", y="Expanded adult Chinook") +
  scale_y_continuous(sec.axis = sec_axis(~./5, name="Discharge (cms)"), limits=c(0,1500)) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d", limits=c(as.Date("2023-9-25"), as.Date("2023-11-01"))) +
  labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Chinook counts (expanded live adults) and water levels (blue line).

<br>

<br>

## Behaviour & carcasses 

```{r}
ggarrange(
  ggplot() +
    geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
               summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
             aes(x=as.Date(date), y=n, fill=section, colour=section), 
             stat="identity", position="stack", alpha=0.7) +
    geom_point(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                 summarize(n=sum(`adults dead`)), 
               aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
    geom_line(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                summarize(n=sum(`adults dead`)), 
              aes(x=as.Date(date), y=n), 
              stat="identity", position="stack") +
    scale_y_continuous(sec.axis = sec_axis(~./1, name="Carcasses")) +
    scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
    labs(x="", y="Expanded live adult Chinook", fill="Segment", colour="Segment") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1)),
  
  ggplot() +
    geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
               summarize(Spawning=sum(`adults # spawning`),
                         Holding = sum(`adults # holding`)) %>% pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
             aes(x=as.Date(date), y=count, fill=behaviour, colour=section), 
             stat="identity", position="stack", alpha=0.7, size=1) +
    geom_point(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                 summarize(n=sum(`adults dead`)), 
               aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
    geom_line(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                summarize(n=sum(`adults dead`)), 
              aes(x=as.Date(date), y=n), 
              stat="identity", position="stack") +
    scale_y_continuous(sec.axis = sec_axis(~./1, name="Carcasses")) +
    scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
    scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
    labs(x="", y="Spawning adult Chinook", fill="Behaviour", colour="Segment") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1)),
  
  nrow=2 
)
```
<br>

Figure: Top: Expanded live Chinook (bars) and carcasses (black line). Bottom: Spawning (gray bars) and holding (white bars) adult Chinook and carcasses (black line). 

<br>

<br>

## Swim & fence counts

```{r}
ggplot() +
   geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
              summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
            aes(x=as.Date(date), y=n, fill=section, colour=section), 
            stat="identity", position="stack", alpha=0.7) + 
    geom_line(data=mile4.fence %>% filter(species=="chinook") %>% group_by(date) %>% summarize(n=sum(count)) %>% mutate(ncum = cumsum(n)),
           aes(x=as.Date(date), y=as.numeric(ncum)), alpha=0.7) +
      geom_point(data=mile4.fence %>% filter(species=="chinook") %>% group_by(date) %>% summarize(n=sum(count)) %>% mutate(ncum = cumsum(n)),
           aes(x=as.Date(date), y=as.numeric(ncum)), alpha=0.7, size=2) +
  scale_y_continuous(breaks=seq(0,1500,by=100), sec.axis = sec_axis(~./1, name="Cumulative fence count (Chinook)")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  labs(x="", y="Expanded adult Chinook (swims)", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Chinook swim counts (expanded adults) relative to cumulative fence counts (black line). 

<br>

<br>

## Oct 3/4 surveys 

<br>

There is some possibility a sizable school of Chinook could have been double counted between the Oct 3 and 4 survey in 2023. 

```{r fig.width=20, fig.height=20}
ggarrange(
  ggplot() +
    geom_point(data=sj.sil %>% filter(species=="Chinook", date==as.Date("2023-10-04")) %>% 
                 group_by(date, segment, page_rowref, unique_ref) %>% 
                 summarize(nlive=sum(`adults live / habitat seen (# Est Live)`),
                           nspawn = sum(`adults # spawning`)) %>% filter(nlive>0),
               aes(y=reorder_within(x=unique_ref, by=page_rowref, within=segment, sep="",), x=nlive, size=nlive), fill="blue", colour="blue") +
    scale_y_discrete(limits=rev) +
    scale_size_continuous(breaks=seq(1, 600, by=125), range=c(1,10)) +
    labs(x="Chinook count", y="River reach (SIL page-row, Habitat, segment)", size="Upper # live \n(Oct 4)") +
    facet_grid(factor(segment, levels=unique(sj.sil$segment))~., scales="free", space="free", switch="y") +
    theme_bw() +
    theme(strip.placement = "outside",                     
          strip.background = element_rect(fill = "white", colour="white"),
          strip.text.y.left = element_text(angle=0, colour="black", face="bold", size=17),
          axis.text = element_text(size=16),
          axis.title = element_text(size=18),
          panel.margin.x=unit(0, "lines") , 
          panel.margin.y=unit(0,"lines"),
          legend.text = element_text(size=15),
          legend.title = element_text(size=16)),
  
  ggplot() +
    geom_point(data=sj.sil %>% filter(species=="Chinook", date==as.Date("2023-10-03")) %>% 
                 group_by(date, segment, page_rowref, page_habitat, unique_ref) %>% 
                 summarize(nlive=sum(`adults live / habitat seen (# Est Live)`),
                           nspawn = sum(`adults # spawning`)) %>% filter(nlive>0),
               aes(y=reorder_within(x=unique_ref, by=page_rowref, within=segment, sep="",), x=nlive, size=nlive), fill="orange", colour="orange") +
    scale_y_discrete(limits=rev) +
    scale_x_continuous(limits=c(1,600,by=100)) +
    scale_size_continuous(breaks=seq(1, 500, by=125), range=c(1,10)) +
    labs(x="Chinook count", y="River reach (SIL page-row, Habitat, segment)", size="Lower # live n(Oct 3)") +
    facet_grid(factor(segment, levels=unique(sj.sil$segment))~., scales="free", space="free", switch="y") +
    theme_bw() +
    theme(strip.placement = "outside",                     
          strip.background = element_rect(fill = "white", colour="white"),
          strip.text.y.left = element_text(angle=0, colour="black", face="bold", size=17),
          axis.text = element_text(size=16),
          axis.title = element_text(size=18),
          legend.text = element_text(size=15),
          legend.title = element_text(size=16)),
nrow=2, ncol=1)
```

<br>

Figure: October 3rd (lower) and 4th (upper) San Juan chinook counts (expanded adults) by segment or SIL row/habitat type. Orientation of y axis represents counts from upstream to downstream reaches. 

<br>

<br>

## Preliminary escapement estimate (PL+D)

<br>

Table: San Juan swim counts (expanded live and dead) and preliminary escapement estimates for three San Juan surveys in 2023. 

```{r}
sj.sil %>% 
  filter(species=="Chinook") %>% 
  group_by(surveyNum, date, section) %>% 
  summarize(expanded_live_adults = round(sum(`adults live / habitat seen (# Est Live)`, na.rm=T),0),
            dead_adults = sum(`adults dead`, na.rm=T)) %>% 
  group_by(surveyNum) %>% 
  mutate(total_exp_adults = round(sum(expanded_live_adults, na.rm=T),0),
         total_dead_adults = round(sum(dead_adults, na.rm=T),0),
         prelim_esc_est = total_exp_adults+total_dead_adults) %>% 
  kbl(align="c") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1:8), valign="middle", target=1) 
```

<br>

<br>

### Tributaries 

Table: Chinook counts (expanded live and dead) for San Juan tributaries (Renfrew, Lens, Harris) and Gordon River in 2023.
```{r}
tribs.sil %>% 
  filter(species=="Chinook") %>% 
  group_by(system,date) %>% 
  summarize(expanded_live_adults = round(sum(`adults live / habitat seen (# Est Live)`),0),
            dead_adults = sum(`adults dead`))%>% 
  kbl(align="c") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1:1), valign="middle", target=1) 
```






