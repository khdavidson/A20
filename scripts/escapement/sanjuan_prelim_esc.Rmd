---
title: "San Juan escapement 2023 (PRELIM)"
author: "South Coast StA"
date: "Last update: `r Sys.Date()`"
output: html_document
knit: (function(inputFile, encoding) { 
  rmarkdown::render(inputFile, encoding=encoding, output_file=paste0(substr(inputFile,1,nchar(inputFile)-4), "_PRELIMINARY_", format(Sys.Date(), sep="_", "%Y-%m-%d"), '.html')) 
  }
  )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, message=F, out.width='1000px', dpi=300)

# Load libraries ----------------------------
library(tidyverse)
library(readxl)
library(here)
library(ggpubr)
library(kableExtra)

# Helpers ----------------------------
analysis_year <- 2023

# ============================= Load data ============================

# SILS ----------------------------
sj.sil <- readxl::read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/2023/SILs/Area 20/A20_Port_Renfrew_2023.xlsx", sheet="Port Renfrew raw SIL entry", guess_max=20000) %>%
  filter(system=="San Juan") %>% 
  print()

tribs.sil <- readxl::read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/2023/SILs/Area 20/A20_Port_Renfrew_2023.xlsx", sheet="Port Renfrew raw SIL entry", guess_max=20000) %>%
  filter(system!="San Juan") %>%
  print()


# Hatchery ----------------------------
mile4.fence <- readxl::read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/San_Juan_Fence_2022-present.xlsx", sheet="Sheet1", guess_max=20000) %>%
  filter(year==analysis_year) %>% 
  print()


# Enviro ----------------------------
sj.water <- list.files(here::here("data"), pattern = "08HA010", full.names = T) %>% 
  map(~read.csv(file=.x, skip=9)) %>%
  purrr::list_rbind() %>%
  mutate(date = as.Date(Date..PST.),
         Parameter = case_when(Parameter==46~"water level",
                               Parameter==47 ~ "discharge")) %>%
  rename(level_m = Value.m.,
         cms = Value.m..s.) %>%
  print()
```

<br>

<br>


## **Chinook** ##

Six snorkel surveys and one helicopter survey were conducted for Chinook in 2023. 

<br>

### Counts & environmentals ###

```{r }
ggarrange(
  ggplot() +
    geom_ribbon(data=sj.water %>% group_by(date) %>% summarize(minL=min(level_m,na.rm=T), maxL=max(level_m,na.rm=T), 
                                                               minD=min(cms,na.rm=T), maxD=max(cms,na.rm=T)) %>% filter(across(c(minL:maxD), ~.!="Inf")), 
                aes(x=as.Date(date), ymin=minD*5, ymax=maxD*5), fill="dodger blue", alpha=0.5) +
    geom_line(data=sj.water %>% group_by(date) %>% summarize(meanL = mean(level_m,na.rm=T),
                                                             meanD = mean(cms,na.rm=T)) %>% filter(across(c(meanL:meanD), ~.!="Inf")), 
              aes(x=as.Date(date), y=meanD*5), colour="dodger blue") +
    geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
               summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
             aes(x=as.Date(date), y=n, fill=section, colour=section), 
             stat="identity", position="stack", alpha=0.7) +
    geom_point(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                 summarize(n=sum(`adults dead`)), 
               aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
    geom_line(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                summarize(n=sum(`adults dead`)), 
              aes(x=as.Date(date), y=n), 
              stat="identity", position="stack") +
    labs(x="", y="Expanded adult Chinook") +
    scale_y_continuous(sec.axis = sec_axis(~./5, name="Discharge (cms)"), limits=c(0,1500)) +
    scale_x_date(date_breaks="7 day", date_labels="%b %d", limits=c(as.Date("2023-9-25"), as.Date("2023-11-01"))) +
    labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1)),
  
  ggplot() +
    geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
               summarize(n=sum(`adults # spawning`)), 
             aes(x=as.Date(date), y=n, fill=section, colour=section), 
             stat="identity", position="stack", alpha=0.7) +
    geom_point(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                 summarize(n=sum(`adults dead`)), 
               aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
    geom_line(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
                summarize(n=sum(`adults dead`)), 
              aes(x=as.Date(date), y=n), 
              stat="identity", position="stack") +
    scale_y_continuous(sec.axis = sec_axis(~./1, name="Carcasses")) +
    scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
    labs(x="", y="Spawning adult Chinook", fill="Segment", colour="Segment") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1)),
  
  nrow=2, common.legend = T, legend = "bottom"
)
```

Figure: Top: Chinook counts (expanded live adults), water levels (blue line), and carcasses (black line). Bottom: Chinook counts (spawning adults) and carcasses. 

<br>

<br>

```{r}
ggplot() +
   geom_bar(data=sj.sil %>% filter(species=="Chinook") %>% group_by(date, section) %>% 
              summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
            aes(x=as.Date(date), y=n, fill=section, colour=section), 
            stat="identity", position="stack", alpha=0.7) + 
    geom_line(data=mile4.fence %>% filter(species=="chinook") %>% group_by(date) %>% summarize(n=sum(count)) %>% mutate(ncum = cumsum(n)),
           aes(x=as.Date(date), y=as.numeric(ncum)), alpha=0.7) +
      geom_point(data=mile4.fence %>% filter(species=="chinook") %>% group_by(date) %>% summarize(n=sum(count)) %>% mutate(ncum = cumsum(n)),
           aes(x=as.Date(date), y=as.numeric(ncum)), alpha=0.7, size=2) +
  scale_y_continuous(breaks=seq(0,1500,by=100), sec.axis = sec_axis(~./1, name="Cumulative fence count (Chinook)")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  labs(x="", y="Expanded adult Chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Left: Chinook swim counts (expanded adults) with fence counts (gray bars). Right: Chinook counts (spawning adults) and swim-ins (gray bars). 

<br>

<br>

### Oct 3/4 surveys 

<br>

There is some possibility a sizable school of Chinook could have been double counted between the Oct 3 and 4 survey in 2023. 

```{r}
ggplot(data=sj.sil %>% filter(species=="Chinook", date%in%c(as.Date("2023-10-03"), as.Date("2023-10-4"))) %>% group_by(date, section, segment) %>% 
         summarize(nlive=sum(`adults live / habitat seen (# Est Live)`),
                   nspawn = sum(`adults # spawning`))) +
  geom_bar(aes(x=segment, y=nlive), stat="identity" )
```

























Table: Escapement estimates with/without helicopter survey for each survey life value.
```{r}
auc23 %>% 
  group_by(method) %>% 
  summarize(fish_days_SL20 = round(sum(`expanded adult`)/20,0),
            fish_days_SL225 = round(sum(`expanded adult`)/22.5,0),
            fish_days_SL25 = round(sum(`expanded adult`)/25,0)) %>% 
  pivot_longer(cols=c(fish_days_SL20:fish_days_SL25), names_to = "Rank", values_to="Estimate") %>% 
  mutate(Rank = case_when(grepl("20", Rank) ~ "Low Value",
                           grepl("225", Rank) ~ "Middle Value",
                           grepl("25", Rank) ~ "High Value"),
         SL = case_when(grepl("Low", Rank) ~ 20,
                        grepl("Middle", Rank) ~ 22.5,
                        grepl("High", Rank) ~ 25)) %>%
  relocate(SL, .after = Rank) %>%
  kbl(align="c") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

<br>

### Tributaries ### 

Chinook were not seen in any Nitinat River or Lake tributaries in 2023.

```{r}
tribs.sil %>% 
  filter(species=="Chinook") %>% 
  group_by(system) %>% 
  summarize(exp_ad_live = sum(`adults live / habitat seen (# Est Live)`))
```






