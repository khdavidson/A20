---
title: "part1-esc-knitable"
author: "South Coast StA"
date: 'Last update: `r format(Sys.time(), sep="_", "%Y-%m-%d %H:%M")`'
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
params:
    password:
      label: "Enter computer password"
      value: ""
      input: password
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, message=F)

# Load libraries ------------------------
#library(here)
library(tidyverse)
#library(readxl)
# library(kableExtra)
# library(bookdown)  
# library(scales)       # for label_percent()
# library(ggpubr)       # for ggarrange()
# library(saaWeb)


# Helpers/functions ------------------------
"%notin%" <- Negate("%in%")
analysis_year <- 2024




# ====================== ENUMERATION data ====================== 
# Option 1. Re-run source (not in knitr) for annual updates ------------------------
# source(here::here("scripts", "functions", "pullNusedsData.R"))
  # saves as a20_nuseds_escapement

# Option 2. Load dumped data ------------------------
a20_nuseds_escapement <- readxl::read_excel(path=here::here("outputs", 
                                                      list.files(path=here::here("outputs"), 
                                                                 pattern="R_OUT - Area20WCVI_Escapement_allSpp-allYrs*")),
                                            sheet="Sheet1")



# Long-term time series (merge NuSEDS and Esc Index for complete time series) ----------------------- 
sj.esc <- full_join(a20_nuseds_escapement,
                    readxl::read_excel("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/NEW ESCAPEMENT INDEX.xls", 
                               sheet="EscData", skip=4) %>%
                      select(-c(`...17`)) %>% 
                      filter(Area==20, (Year %notin% unique(a20_nuseds_escapement$year) | Year==2004)) %>%
                      mutate(across(c("Ck Escape":"Brd Rem Cm"), ~ifelse(. %in% c("AP", "NO", "t"), NA, as.numeric(.)))) %>%
                      select(c(Area:`Brd Rem Cm`)) %>%
                      mutate(Ck_spawners=`Ck Escape`-`Brd Rem Ck`,
                             Co_spawners=`Coho Esc`-`Brd Rem Co`,
                             Cm_spawners=`Chum Esc`-`Brd Rem Cm`) %>%
                      pivot_longer(cols=c(`Ck Escape`:Cm_spawners), names_to = "est_type", values_to="estimate") %>%
                      mutate(Species = case_when(grepl("Ck|Chinook", est_type) ~ "Chinook",
                                                 grepl("Co|Coho", est_type) ~ "Coho",
                                                 grepl("Cm|Chum", est_type) ~ "Chum",
                                                 TRUE ~ "FLAG"),
                             est_type = case_when(grepl("Brd Rem", est_type) ~ "Adult Broodstock Removals",
                                                  grepl("Esc", est_type) ~ "Total Adult Return River",
                                                  grepl("spawners", est_type) ~ "Natural Adult Spawners")) %>%     
                      rename(year=Year,
                             waterbody_name=System) %>% 
                      mutate(source="New Esc Index") %>%
                      mutate_at("Area", as.character)) %>% 
  mutate(SJ_watershed_group = case_when(grepl("Harris|Lens|Renfrew|San Juan", waterbody_name, ignore.case=T) ~ 
                                          "core SJ watershed",
                                        TRUE ~ "other")) %>%
  print()


# Remove Nuseds dataframe to avoid confusion ----------------------- 
remove(a20_nuseds_escapement)




# Habitat model benchmarks ----------------------- 
RPs <- read.csv(here::here("data", "escapement", "wcviCK-BootstrappedRPs.csv")) %>%
  filter(Stock=="San Juan")


# Timing -----------------------
# sj.cn.timing <- read_excel("//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/ESCAPEMENT/Data/run timing tables (updated).xlsx", sheet="San Juan", range="A4:W65") %>% 
#   rename(year=`...1`,
#          system=`81`) %>%
#   fill(year) %>%
#   filter(year!=max(year) | !is.na(system)) %>% 
#   pivot_longer(`82`:`124`, names_to = "stat_week", values_to = "count") %>%
#   filter(system=="SJ", !is.na(stat_week))
# sj.cn.timing$stat_week <- factor(sj.cn.timing$stat_week, levels=c("81","82","83","84","91","92","93","94","101","102","103","104","105",
#                                                                   "111","112","113","114","115","121","122","123","124", ordered=T))

SJ.rtStWk <- readxl::read_excel(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/DATA/run timing tables (updated).xlsx",
                                sheet="San Juan", guess_max=10000, trim_ws=T, range=cellranger::cell_limits(c(4, 1), c(NA, NA))) %>% 
  select(-c(...25:NOTES,...34:...43)) %>%
  rename(Year=`...1`) %>% 
  filter(if_any(everything(), ~ !is.na(.)), !grepl("Observed|Year", Year), !is.na(Year)) %>% 
  mutate(across(c(`81`:`124`), ~as.numeric(.)),
         plot_group = case_when(Year==analysis_year ~ Year,
                                Year!=analysis_year ~ paste0(min(Year), sep="-", (analysis_year-1)))) %>%
  pivot_longer(cols = c(`81`:`124`), names_to = "stat_week", values_to = "count") %>% 
  rename(Species=species_R) %>%
  print()

SJ.rtStWk$stat_week <- factor(SJ.rtStWk$stat_week,
                               levels=c("81","82","83","84",
                                        "91","92","93","94", "95",
                                        "101","102","103","104","105",
                                        "111","112","113","114","115",
                                        "121","122","123","124", ordered=T))



# Hatchery releases for comparison -----------------------
SJRelSEP <- lapply(list.files(path=here::here("data", "enhancement-PNI"),
                              pattern = "^SEP RELEASES_all-years-spp.*\\.xlsx$",
                              full.names = TRUE), 
                   readxl::read_excel, sheet="Actual Release") %>% 
  do.call("cbind",.) %>%
  filter(STOCK_NAME=="San Juan R") %>%
  print()






# ============================== FENCE ==============================
sj.fence <- readxl::read_excel(here::here("data", "escapement", "San_Juan_Fence_2020-present.xlsx"), sheet="Sheet1") %>%
  mutate(DOY = lubridate::yday(date)) %>%
  mutate_at("year", as.factor) %>%
  print()

sj.fence$stat_week <- factor(sj.fence$stat_week,
                               levels=c("81","82","83","84",
                                        "91","92","93","94", "95",
                                        "101","102","103","104","105",
                                        "111","112","113","114","115",
                                        "121","122","123","124", ordered=T))






# ====================== AGE data ======================   (all species, all years - not linked to individual fish)
# Option 1: Re-dump source code for updates ------------------
 #source(here::here("scripts", "functions", "pullSanJuanAgeData.R"))
  # saves as SJ_allAgesMaster


# Option 2: Load pre-dumped age data ------------------
# Load SJ specific data so I can get non-Chinook ages too
SJ_allAgesMaster <- readxl::read_excel(path=list.files(path=here::here("outputs"), 
                                                       pattern="R_OUT - SanJuan_Ages_allSpp-allYrs",
                                                       full.names = T)) %>%
  mutate(`(R) RESOLVED TOTAL AGE` = case_when(PADS_GrAge == "0M" ~ "1",
                                              grepl("chinook", PADS_Species, ignore.case=T) & PADS_GrAge == "1M" ~ "2",
                                              grepl("chinook", PADS_Species, ignore.case=T) & PADS_GrAge == "2M" ~ "3",
                                              grepl("chinook", PADS_Species, ignore.case=T) & PADS_GrAge == "3M" ~ "4",
                                              grepl("chinook", PADS_Species, ignore.case=T) & PADS_GrAge == "4M" ~ "5",
                                              grepl("chinook", PADS_Species, ignore.case=T) & PADS_GrAge == "5M" ~ "6",
                                              grepl("chinook", PADS_Species, ignore.case=T) & PADS_GrAge == "6M" ~ "7",
                                              PADS_GrAge %in% c("10","11") ~ "1",
                                              PADS_GrAge %in% c("20","21","22") ~ "2",
                                              PADS_GrAge %in% c("30","31","32","33") ~ "3",
                                              PADS_GrAge %in% c("40","41","42","43","44") ~ "4",
                                              PADS_GrAge %in% c("50","51","52","53","54","55") ~ "5",
                                              PADS_GrAge %in% c("60","61","62","63","64","65") ~ "6",
                                              PADS_GrAge %in% c("70","71","72","73","74","75","76","77") ~ "7",
                                              TRUE ~ PADS_GrAge),
         Species = case_when(grepl("chinook", PADS_Species, ignore.case=T) ~ "Chinook",
                             grepl("Coho", PADS_Species, ignore.case=T) ~ "Coho",
                             TRUE ~ "FLAG"))



# ============================== LINKED BIODATA ==============================
# LM to use FL to predict for missing POH:
POH.lm.M.b <-  coef(lm(data = sj.biodata%>%filter(Sex=="Male"),
                        formula = as.numeric(`POH Length (mm)`) ~ as.numeric(`Fork Length (mm)`)))[1]
POH.lm.M.m <-  coef(lm(data = sj.biodata%>%filter(Sex=="Male"),
                        formula = as.numeric(`POH Length (mm)`) ~ as.numeric(`Fork Length (mm)`)))[2]
 
POH.lm.F.b <-  coef(lm(data = sj.biodata%>%filter(Sex=="Female"),
                        formula = as.numeric(`POH Length (mm)`) ~ as.numeric(`Fork Length (mm)`)))[1]
POH.lm.F.m <-  coef(lm(data = sj.biodata%>%filter(Sex=="Female"),
                        formula = as.numeric(`POH Length (mm)`) ~ as.numeric(`Fork Length (mm)`)))[2]



sj.biodata <- readxl::read_excel(list.files(path="//ENT.DFO-MPO.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/CHINOOK/WCVI_TERMINAL_RUN/Annual_data_summaries_for_RunRecons/",
                                              pattern="^R_OUT - WCVI_Escapement-FSC_BioData_*.*xlsx",
                                            full.names=T),
                                  sheet="Esc biodata w RESULTS", guess_max=20000) %>% 
  filter(`Fishery / River` == "San Juan River") %>%
  mutate(Sex = case_when(Sex=="J" ~ "Jack",
                         Sex=="M" ~ "Male",
                         Sex=="F" ~ "Female",
                         TRUE ~ Sex)) %>%
  mutate(`POH Length (mm)` = case_when(is.na(`POH Length (mm)`) & Sex=="Male" ~ 
                                         POH.lm.M.m*as.numeric(`Fork Length (mm)`) + POH.lm.M.b,
                                       is.na(`POH Length (mm)`) & Sex=="Female" ~ 
                                         POH.lm.F.m*as.numeric(`Fork Length (mm)`) + POH.lm.F.b,
                                       TRUE ~ as.numeric(`POH Length (mm)`)))



# ============================== MISC BIODATA ==============================
# Fecundity data --------------
sj.fecund <- readxl::read_excel(here::here("data", "biosamples", "San Juan misc biodata all years.xlsx"), sheet="fecundity")

# Sex ratio data --------------
sj.SR <- readxl::read_excel(here::here("data", "biosamples", "San Juan misc biodata all years.xlsx"), sheet="SexRatio")



# ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~


# ==============================
# Age comp each year
sj_age_summary <- SJ_allAgesMaster %>%
  filter(!is.na(`(R) RESOLVED TOTAL AGE`), `(R) RESOLVED TOTAL AGE` %in% c("1","2","3","4","5","6","7")) %>%
  group_by(`(R) SAMPLE YEAR`, Species, `(R) RESOLVED TOTAL AGE`) %>%
  summarize(count = n()) %>%
  group_by(`(R) SAMPLE YEAR`, Species) %>%
  mutate(year_total = sum(count),
         propn = count/year_total) %>%
  print()

# Entire time series average age comp
sj_LT_avgs <- sj_age_summary %>%
  group_by(Species, `(R) RESOLVED TOTAL AGE`) %>%
  summarize(avg_propn = round(mean(propn),3),
            sd_propn = round(sd(propn),3)) %>%
  rename(res_age = `(R) RESOLVED TOTAL AGE`) %>%
  print()

# Recent 12-year average age comp
sj_12Y_avgs <- sj_age_summary %>%
  filter(`(R) SAMPLE YEAR`>=analysis_year-12) %>%
  group_by(Species, `(R) RESOLVED TOTAL AGE`) %>%
  summarize(avg_propn = round(mean(propn),3),
            sd_propn = round(sd(propn),3)) %>%
  rename(res_age = `(R) RESOLVED TOTAL AGE`) %>%
  print()

# 2023 cycle line age comp
# sj_cycle_avgs <- sj_age_summary %>%
#   filter(RecoveryYear%in%c(lubridate::year(Sys.Date())-12) : lubridate::year(Sys.Date())) %>%
#   group_by(`(R) RESOLVED AGE`) %>%
#   summarize(avg_propn = round(mean(propn)*100,1),
#             sd_propn = round(sd(propn)*100,1)) %>%
#   rename(resolved_age = `(R) RESOLVED AGE`) %>%
#   arrange(desc(avg_propn)) %>%
#   slice(1:2) %>%
#   print()
```

# **Abundance and biodata** {#esc}

Status snapshot:

-   Chinook enhancement began 1978

-   Recent 12-yr average adult escapement (incl broodstock): `r sj.esc %>% filter(est_type=="Total Adult Return River", SJ_watershed_group=="core SJ watershed", Species=="Chinook", year>=(analysis_year-12)) %>% group_by(year) %>% summarize(esc_total=sum(estimate,na.rm=T)) %>% summarize(mean=round(mean(esc_total,na.rm=T),0)) %>% pull(mean)`

    -   Range: `r sj.esc %>% filter(est_type=="Total Adult Return River", SJ_watershed_group=="core SJ watershed", Species=="Chinook", year>=(analysis_year-12)) %>% group_by(year) %>% summarize(esc_total=sum(estimate,na.rm=T)) %>% summarize(min=min(esc_total)) %>% pull(min)` - `r sj.esc %>% filter(est_type=="Total Adult Return River", SJ_watershed_group=="core SJ watershed", Species=="Chinook", year>=(analysis_year-12)) %>% group_by(year) %>% summarize(esc_total=sum(estimate,na.rm=T)) %>% summarize(max=max(esc_total)) %>% pull(max)`

-   Recent 4-yr avg adult escapement (incl broodstock): `r sj.esc %>% filter(est_type=="Total Adult Return River", SJ_watershed_group=="core SJ watershed", Species=="Chinook", year>=(analysis_year-4)) %>% group_by(year) %>% summarize(esc_total=sum(estimate,na.rm=T)) %>% summarize(mean=round(mean(esc_total,na.rm=T),0)) %>% pull(mean)`

    -   Range: `r sj.esc %>% filter(est_type=="Total Adult Return River", SJ_watershed_group=="core SJ watershed", Species=="Chinook", year>=(analysis_year-4)) %>% group_by(year) %>% summarize(esc_total=sum(estimate,na.rm=T)) %>% summarize(min=min(esc_total)) %>% pull(min)` - `r sj.esc %>% filter(est_type=="Total Adult Return River", SJ_watershed_group=="core SJ watershed", Species=="Chinook", year>=(analysis_year-4)) %>% group_by(year) %>% summarize(esc_total=sum(estimate,na.rm=T)) %>% summarize(max=max(esc_total)) %>% pull(max)`

-   Long-term age structure (entire time series): `r sj_LT_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(1) %>% pull(res_age[1])` year olds (`r sj_LT_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(1) %>% pull(avg_propn[1])*100` +/- `r sj_LT_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(1) %>% pull(sd_propn[1])*100`%) followed by `r sj_LT_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(2) %>% pull(res_age[1])` year olds (`r sj_LT_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(2) %>% pull(avg_propn[1])*100` +/- `r sj_LT_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(2) %>% pull(sd_propn[1])*100`%)

-   Recent (12yr) dominant age structure: `r sj_12Y_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(1) %>% pull(res_age[1])` year olds (`r sj_12Y_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(1) %>% pull(avg_propn[1])*100` +/- `r sj_12Y_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(1) %>% pull(sd_propn[1])*100`%) followed by `r sj_12Y_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(2) %>% pull(res_age[1])` year olds (`r sj_12Y_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(2) %>% pull(avg_propn[1])*100` +/- `r sj_12Y_avgs %>% filter(Species=="Chinook") %>% arrange(desc(avg_propn)) %>% slice(2) %>% pull(sd_propn[1])*100`%)

-   Hatchery vs wild: uncertain due to historical marking/tagging process. Mostly unclipped with no thermal mark (but historical TM process highly unreliable)

<br>

## Escapement

San Juan Chinook escapement has varied over time. From its peak at 7500 in 1970 it declined to less than 250 fish between 1975-1978, but has since returned to escapements that tend to oscillate around 2000-4000 fish (see Figure \@ref(fig:sj-esc-fig)). While broodstock collections are only documented in NuSEDS from 1995 onward, the first document hatchery release group was 1979.

```{r sj-esc-fig, fig.cap='Spawners and broodstock removals for San Juan Chinook, specific adults only where known. Vertical dashed gray line(s) indicate periods of enhancement. Horizontal dashed black line indicates habitat-model based Smsy estimate. Data from NuSEDS; red outlined bars (if any) indicate escapement estimates not in NuSEDS.'}

# CHINOOK ESCAPEMENT FIGURE ----------------------- 

pdf(file = here::here("outputs", "figures", "San Juan Chinook escapement and benchmarks.pdf"),   
    width = 14, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches


ggplot() +
  # --- Enhancement start vertical line:
  geom_vline(data=SJRelSEP %>% 
               filter(SPECIES_NAME=="Chinook") %>% 
               group_by(SPECIES_NAME) %>% 
               summarize(start=min(BROOD_YEAR)) %>% 
               rename(Species=SPECIES_NAME)%>%
               mutate(n=7000),
             aes(xintercept=start), colour="gray60", linetype="dashed", size=0.5) +
  # --- Escapement goals: PFN 
  geomtextpath::geom_textline(aes(x=unique(sj.esc$year), y=10000, label="PFN Biological-based benchmark"), 
                              colour="black", linewidth=1, show.legend=F, hjust=-0.01, text_smoothing=30, size=4) +
  # --- Escapement goal: DFO 
  geomtextpath::geom_textline(aes(x=unique(sj.esc$year), y=RPs[RPs$RP=="SMSY",]$Value, label="DFO Smsy"), 
                              colour="gold", linewidth=1, show.legend=F, hjust=-0.01, text_smoothing=30, size=4) +
  geomtextpath::geom_textline(aes(x=unique(sj.esc$year), y=RPs[RPs$RP=="SGEN",]$Value, label="DFO Sgen"), 
                              colour="red", linewidth=1, show.legend=F, hjust=-0.01, text_smoothing=30, size=4) +
  geomtextpath::geom_textline(aes(x=unique(sj.esc$year), y=RPs[RPs$RP=="SREP",]$Value, label="DFO Srep"), 
                              colour="green", linewidth=1, show.legend=F, hjust=-0.01, text_smoothing=30, size=4) +
  
  # --- NuSEDS escapement data:
  geom_bar(data=sj.esc %>% filter(Species=="Chinook", source=="NuSEDS",
                                  est_type %in% c("Unspecified Return", "Natural Adult Spawners", "Adult Broodstock Removals"),
                                  !is.na(estimate), Species=="Chinook") %>%
             group_by(year, est_type, SJ_watershed_group)%>%summarize(estimate=sum(estimate))%>%
             filter(SJ_watershed_group=="core SJ watershed"),
           aes(x=year, y=as.numeric(estimate), fill=est_type, colour=est_type),
           stat="identity", alpha=0.7, width=0.9, size=0.3) +
  
  # --- New Escapement Index data:
  geom_bar(data=sj.esc %>%
             filter(Species=="Chinook", est_type%in%c("Natural Adult Spawners", "Adult Broodstock Removals"),
                    source=="New Esc Index", Species=="Chinook", SJ_watershed_group=="core SJ watershed"),
           aes(x=year, y=estimate, fill=est_type), colour="transparent", stat="identity", alpha=0.4, width=0.9, size=0.5) +

  # ----- Highlight New Escapement Index data in red: 
  geom_bar(data=sj.esc %>%
             filter(Species=="Chinook", est_type%in%c("Natural Adult Spawners", "Adult Broodstock Removals"),
                    source=="New Esc Index", Species=="Chinook", SJ_watershed_group=="core SJ watershed")%>%
             group_by(year,Species) %>% 
             summarize(total=sum(estimate)),
           aes(x=year, y=total), stat="identity", width=0.9, size=0.7, fill="transparent", colour=alpha("red", 0.5), linetype="dotted") +
  
  # --- Formatting
  scale_x_continuous(breaks=seq(min(sj.esc$year), max(sj.esc$year), by=3)) +
  scale_y_continuous(breaks=seq(0,10000,by=500)) +
  scale_fill_manual(breaks = c("Natural Adult Spawners", "Adult Broodstock Removals", "Unspecified Return"), 
                    values=c("dodger blue","orange", "gray")) +
  scale_colour_manual(breaks = c("Natural Adult Spawners", "Adult Broodstock Removals", "Unspecified Return"), 
                      values=c("dodger blue","orange", "gray")) +
  labs(x="Return Year", y="Number of Chinook") +
  theme_bw() +
  theme(axis.text = element_text(colour="black",size=11),
        axis.text.x = element_text(angle=45,hjust=1),
        axis.title = element_text(face="bold",size=13),
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        legend.position = c(0.75,0.85),
        legend.background = element_blank(),
        strip.text = element_text(size=10)) +
  guides(colour = guide_legend(override.aes=list(colour=NA))) 

dev.off()
```

<br>

```{r a20-fig, fig.cap='Population-level spawner estimates for salmon in Area 20 (WCVI). Data from NuSEDS.'}

pdf(file = here::here("outputs", "figures", "Area 20 escapement - populations.pdf"),   
    width = 14, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

# FIGURE: All populations Area 21 ----------------------- 
ggplot() +
  # --- Enhancement start vertical line:
  #geom_vline(data=sj.releases.sep%>%group_by(SPECIES_NAME)%>%summarize(start=min(BROOD_YEAR))%>%rename(Species=SPECIES_NAME)%>%
  #             mutate(n=7000),
  #           aes(xintercept=start), colour="gray60", linetype="dashed", size=0.5) +
  # --- Escapement goal and average escapements: 
  #geom_hline(data=data.frame(Species="Chinook", Smsy=2200, Sgen=990, Srep=5200), aes(yintercept=Smsy), size=1, linetype="dashed") +
  #geom_hline(data=sj.esc %>% filter(analysis_year>=(max(analysis_year-10)), est_type=="Natural Adult Spawners") %>% 
  #             summarize(mean=round(mean(n,na.rm=T),0)),
  #           aes(yintercept=mean), size=1, linetype="solid", colour="black") +
  # --- Plot NuSEDS escapement data:
  geom_bar(data=sj.esc %>% 
             filter(est_type %in% c("Unspecified Return", "Natural Adult Spawners", "Adult Broodstock Removals"),
                    !is.na(estimate), !is.na(Population)),
           aes(x=year, y=as.numeric(estimate), fill=est_type, colour=est_type), stat="identity", alpha=0.8, width=0.9, size=0.3) +
  scale_fill_manual(breaks = c("Natural Adult Spawners", "Adult Broodstock Removals", "Unspecified Return"), 
                    values=c("dodger blue","orange", "gray")) +
  scale_colour_manual(breaks = c("Natural Adult Spawners", "Adult Broodstock Removals", "Unspecified Return"), 
                      values=c("dodger blue","orange", "gray")) +
  scale_x_continuous(breaks=seq(0,3000, by=5)) +
  labs(x="Return Year", y="Number of salmon in Area 21 populations") +
  theme_bw() +
  theme(axis.text = element_text(colour="black",size=11),
        axis.text.x = element_text(angle=45,hjust=1, size=9),
        axis.title = element_text(face="bold",size=13),
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.background = element_blank(),
        strip.text = element_text(size=8)) +
  guides(colour = guide_legend(override.aes=list(colour=NA))) +
  facet_wrap(~Population, scales="free_y")

dev.off()
```
<br>

```{r eval=F}
# STUDY DESIGN BY TABLE 
sj.esc %>% 
  filter(est_type %in% c("Unspecified Return", "Natural Adult Spawners", "Adult Broodstock Removals"),
         !is.na(estimate), !is.na(Population)) %>% 
  group_by(year, Species, waterbody_name) %>% 
  summarize()


study_design_year <- 2024

# STUDY DESIGN AVERAGES 
sj.esc %>% 
  filter(est_type %in% c("Unspecified Return", "Natural Adult Spawners", "Natural Jack Spawners"),
         !is.na(estimate), !is.na(Population), SJ_watershed_group=="core SJ watershed") %>% 
  mutate(avggroup = "long-term",
         avggroup = case_when(year %in% seq(study_design_year-12, study_design_year, by=1) ~ paste0(avggroup, ", 12 year"),
                           TRUE ~ avggroup),
         avggroup = case_when(year %in% seq(study_design_year-8, study_design_year, by=1) ~ paste0(avggroup, ", 8 year"),
                           TRUE ~ avggroup),
         avggroup = case_when(year %in% seq(study_design_year-4, study_design_year, by=1) ~ paste0(avggroup, ", 4 year"),
                           TRUE ~ avggroup)) %>% 
  group_by(Species, year, avggroup) %>% 
  summarize(ann_esc = sum(estimate)) %>% 
  group_by(Species, avggroup) %>% 
  summarize(mean_esc = mean(ann_esc))
```


<br>

```{r CU-fig, fig.cap='Conservation Unit (CU) level spawner estimates. Data from NuSEDS.'}

pdf(file = here::here("outputs", "figures", "Area 20 escapement - CU.pdf"),   
    width = 14, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

ggplot() +
  geom_bar(data=sj.esc %>% 
             filter(est_type %in% c("Unspecified Return", "Natural Adult Spawners", "Adult Broodstock Removals") &
                    !is.na(estimate), !is.na(`Conservation Unit Name`)) %>% 
             mutate(CUspp=paste0(`Conservation Unit Name`, sep=" - ", Species)) %>%
             group_by(year, CUspp, est_type) %>% 
             summarize(estimate=sum(estimate, na.rm=T)),
           aes(x=year, y=as.numeric(estimate), fill=est_type, colour=est_type), stat="identity", alpha=0.8, width=0.9, size=0.3) +
  scale_fill_manual(breaks = c("Natural Adult Spawners", "Adult Broodstock Removals", "Unspecified Return"), 
                    values=c("dodger blue","orange", "gray")) +
  scale_colour_manual(breaks = c("Natural Adult Spawners", "Adult Broodstock Removals", "Unspecified Return"), 
                      values=c("dodger blue","orange", "gray")) +
  scale_x_continuous(breaks=seq(0,3000,by=5)) +
  labs(x="Return Year", y="Number of salmon in Area 20 CUs") +
  theme_bw() +
  theme(axis.text = element_text(colour="black",size=11),
        axis.text.x = element_text(angle=45,hjust=1, size=9),
        axis.title = element_text(face="bold",size=13),
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.background = element_blank(),
        strip.text = element_text(size=8)) +
  guides(colour = guide_legend(override.aes=list(colour=NA))) +
  facet_wrap(~CUspp, scales="free_y")

dev.off()
```

<br>

### Escapement goals {#esc-goals}

The current escapement goals developed by Holt et al. based on a habitat model (Parken et al 2008), which are estimates of individual fish (not spawning pairs - requires assumptions about sex ratios to infer juvenile output):

-   Smsy: `r RPs %>% filter(RP=="SMSY") %>% pull(Value)` (`r RPs %>% filter(RP=="SMSY") %>% pull(lwr)`-`r RPs %>% filter(RP=="SMSY") %>% pull(upr)`) - The escapement required to produce maximum sustainable yield

-   Sgen: `r RPs %>% filter(RP=="SGEN") %>% pull(Value)` (`r RPs %>% filter(RP=="SGEN") %>% pull(lwr)`-`r RPs %>% filter(RP=="SGEN") %>% pull(upr)`) - The escapement required to recover to Smsy in 1 generation

-   Srep: `r RPs %>% filter(RP=="SREP") %>% pull(Value)` (`r RPs %>% filter(RP=="SREP") %>% pull(lwr)`-`r RPs %>% filter(RP=="SREP") %>% pull(upr)`) - System capacity

Additional benchmarks for use:  

-   Fish Stock Provisions Rebuilding goal (Sgen * 1.5) = `r RPs %>% filter(RP=="SGEN") %>% pull(Value)*1.5`

-   Pacheedaht/Burt habitat capacity estimate = 10,000 spawning pairs  

-   Pacheedaht Rebuilding Goal: 5,000

<br>

<br>

## Run timing {#timing}

Most chinook are observed in the San Juan between late September (statweek 94) and mid October (statweek 102) (Figure \@ref(fig:sj-timing)). Run timing counts come from a combination of the fence (which is usually in until Thanksgiving if possible) and swim surveys (which typically start after the fence is removed). Escapement estimates are typically derived from the swim surveys alone. 

```{r sj-timing, fig.cap='Swim and/or fence counts in the San Juan River from 1995-present. Counts are more representative of arrival rather than peak spawning. Stat week is interpreted as the month and week surveys occurred (e.g., Stat week 81 = first week of August; stat week 93 = third week of September, etc.). Stock Assessment data.'}

pdf(file = here::here("outputs", "figures", "San Juan run timing (all species).pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

ggplot() +
  geom_point(data=SJ.rtStWk %>% filter(System=="SJ"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adults (raw)", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "right",
        legend.box = "vertical") +
  facet_wrap(~Species, nrow=3)

dev.off()



pdf(file = here::here("outputs", "figures", "San Juan run timing (chinook only).pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

ggplot() +
  geom_point(data=SJ.rtStWk %>% filter(System=="SJ" & Species=="Chinook"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(2.5,4)) +
  labs(x="Stat week", y="Live Chinook adults (raw)", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=12),
        axis.title = element_text(face="bold", size=14),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12, face="bold"),
        legend.position = "right",
        legend.box = "vertical") 

dev.off()
```

<br>

Daily fence counts have not been historically supplied except for the last three years (Fig \@ref(fig:fence-timing)). 

```{r fence-timing, fig.cap='Chinook counts through the fence only in the San Juan River. Counts include fish kept for brood and released upstream of the fence. Data from 4 Mile Hatchery.'}
  ggplot() +
    geom_point(data=sj.fence %>% 
                 filter(method=="fence", species=="chinook", disposition%in%c("kept for brood", "released upstream"))%>%
                 group_by(year,DOY)%>%
                 summarize(count=sum(count)), 
               aes(x=as.Date(DOY, origin = as.Date("1970-12-31")), y=count, group=year, fill=year,colour=year), size=3) +
    geom_line(data=sj.fence %>% 
                filter(method=="fence", species=="chinook",disposition%in%c("kept for brood", "released upstream"))%>%
                group_by(year,DOY)%>%
                summarize(count=sum(count)), 
              aes(x=as.Date(DOY, origin = as.Date("1970-12-31")), y=count, group=year, fill=year,colour=year), size=1) +
    scale_x_date(date_labels = "%b %d", date_breaks = "2 day") +
    labs(x="Date", y="Adult Chinook count from fence", fill="Year:", colour="Year:")+
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1))
```

<br>

<br>


## Upcoming return {#forecast}

The `r lubridate::year(Sys.Date())` return will be composed of offspring from the following brood years:

```{r by-table}
study_design_year <- 2024

BYtables <- sj.esc %>% 
  mutate(BYtables = case_when(Species=="Chinook" & year %in% seq(study_design_year-6, study_design_year-2, by=1) ~ "use",
                              Species=="Coho" & year %in% seq(study_design_year-4, study_design_year-2, by=1) ~ "use",
                              Species=="Chum" & year %in% seq(study_design_year-5, study_design_year-4, by=1) ~ "use",
                              Species=="Pink" & year %in% seq(study_design_year-2, study_design_year-2, by=1) ~ "use",
                              Species=="Sockeye" & year %in% seq(study_design_year-5, study_design_year-4, by=1) ~ "use",
                              TRUE ~ "FLAG")) %>%
  filter(est_type%in%c("Natural Adult Spawners", "Adult Broodstock Removals"), BYtables=="use") %>%
  group_by(waterbody_name, Species, year) %>%
  summarize(`Escapement (spawners+broodstock)`=sum(estimate,na.rm=T)) %>%
  mutate(across(c(`Escapement (spawners+broodstock)`), ~ format(.x, big.mark = ","))) %>% 
  rename(`Return year` = year) 

BYtables %>%
  kableExtra::kbl(align="c", caption="Brood year escapement (spawners+broodstock) contributing to the 2023 return. Data from NuSEDS.") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") 
```

```{r}
writexl::write_xlsx(x=BYtables, path=here::here("outputs", "R_OUT - Area 20 Brood Year Tables.xlsx"))
```


<br>

See study design for forecast: [Area 20 Study Design](//dcbcpbsna01a.ENT.dfo-mpo.ca/SCD_Stad/WCVI/Study_Designs/Adults/Area 20/2024 Area 20 adult assessment study design DRAFT.docx)

<br>

<br>

## Age structure {#escAge}

The adult age structure is primarily 3 and 4 year olds. Jacks and 6 year olds contribute almost nothing to the population, especially in recent years (see Table \@ref(tab:age-tab) and Figure \@ref(fig:age-fig)). Biosample data are primarily obtained from hatchery broodstock, with occaisional, opportunistic deadpitch sampling of the naturally-spawning population. 

<br>

### Hatchery age composition

<br>

```{r age-tab, echo=F, warning=F, message=F}
# TABLE: Overall age structure -----------------------
SJ_allAgesMaster %>% 
  filter(!is.na(`(R) RESOLVED TOTAL AGE`), `(R) RESOLVED TOTAL AGE`%in%c("1","2","3","4","5","6")) %>%
  group_by(`PADS_Sample Source`, `(R) SAMPLE YEAR`, `(R) RESOLVED TOTAL AGE`) %>% 
  summarize(n=n()) %>% 
  group_by(`PADS_Sample Source`, `(R) SAMPLE YEAR`) %>% 
  mutate(propn=n/sum(n)) %>%
  group_by(`PADS_Sample Source`, `(R) RESOLVED TOTAL AGE`) %>% 
  summarize(avg_propn = mean(propn), sd_propn=sd(propn)) %>% 
  mutate(avg_propn=round(avg_propn,3)*100, sd_propn=round(sd_propn,3)*100) %>%
  #unite(col="Average (± SD) %", c(avg_propn, sd_propn), sep=" ± ") %>%
  rename(Age=`(R) RESOLVED TOTAL AGE`,
         `Proportion (avg)` = avg_propn,
         `+/- SD` = sd_propn) %>%
  kableExtra::kbl(align="c", caption="Age structure of San Juan Chinook. Data from PADS (NuSEDS and MRPIS).") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") 
```

<br>

```{r age-fig, echo=F, warning=F, message=F, fig.cap='Annual age structure of San Juan Chinook. Numbers above bars indicate the number of samples contributing age data each year. Data from PADS (NuSEDS and MRPIS).'}

# FIGURE: AGE ~ TIME -----------------------

age.fig.allyrs <- 
  ggplot() +
  geom_bar(data=SJ_allAgesMaster %>% 
             filter(!is.na(`(R) RESOLVED TOTAL AGE`), `(R) RESOLVED TOTAL AGE`%in%c("1","2","3","4","5","6")) %>%
             group_by(`(R) SAMPLE YEAR`, `(R) RESOLVED TOTAL AGE`) %>% 
             summarize(n=n()) %>% 
             group_by(`(R) SAMPLE YEAR`) %>% 
             mutate(sample_size = sum(n),
                    propn=n/sum(n)),
           aes(x=`(R) SAMPLE YEAR`, y=propn, fill=as.factor(`(R) RESOLVED TOTAL AGE`), 
               colour=as.factor(`(R) RESOLVED TOTAL AGE`)), 
           stat="identity", position="stack", alpha=0.8, size=0.5, width=0.8) +
  geom_text(data=SJ_allAgesMaster %>% 
              filter(!is.na(`(R) RESOLVED TOTAL AGE`), `(R) RESOLVED TOTAL AGE`%in%c("1","2","3","4","5","6")) %>% 
              group_by(`(R) SAMPLE YEAR`) %>% 
              summarize(sample_size = n()), 
            aes(x=`(R) SAMPLE YEAR`, y=1.07, label=paste0("n=",sample_size)), size=3, angle=45, vjust=1, hjust=0.5) +
  labs(y="Proportion of all annual biosamples", fill="Age:", colour="Age:") +
  scale_x_continuous(breaks=seq(1990,2050,by=1)) +
  scale_y_continuous(breaks=seq(0,1.1,by=0.25), limits=c(0,1.1), labels=scales::label_percent()) +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=10),
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_text(face="bold", size=13),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(face="bold"),
        plot.caption = element_text(face="italic", hjust=0))
age.fig.allyrs

pdf(file = here::here("outputs", "figures", "San Juan chinook age composition 1990-present.pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

age.fig.allyrs

dev.off()
```

```{r age-sex-fig, echo=F, warning=F, message=F, fig.cap='Annual age structure of San Juan Chinook by sex. Numbers above bars indicate the number of samples contributing age data each year. Data from PADS (NuSEDS and MRPIS).'}
age.fig.sex <- ggplot() +
  geom_bar(data=sj.biodata %>%
             filter(!is.na(`(R) RESOLVED TOTAL AGE`), Sex%in%c("Male","Female","Jack")) %>%
             group_by(Sex, `(R) SAMPLE YEAR`, `(R) RESOLVED TOTAL AGE`) %>%
             summarize(n=n()) %>%
             group_by(`(R) SAMPLE YEAR`, Sex) %>%
             mutate(total_n = sum(n),
                    propn = n/total_n), 
           aes(x=`(R) SAMPLE YEAR`, y=propn, fill=as.factor(`(R) RESOLVED TOTAL AGE`), 
               colour=as.factor(`(R) RESOLVED TOTAL AGE`)), 
           stat="identity", position="dodge", alpha=0.7, width=0.5) +
  geom_text(data=sj.biodata %>%
              filter(!is.na(`(R) RESOLVED TOTAL AGE`), Sex%in%c("Male","Female","Jack")) %>%
              group_by(`(R) SAMPLE YEAR`, Sex) %>%
              summarize(total_n = n()), 
            aes(x=`(R) SAMPLE YEAR`, y=1.04, label=paste0("n=",total_n)), size=3) +
  labs(x="Brood year", y="% Hatchery biosamples by sex", fill="Age:", colour="Age:") +
  scale_y_continuous(labels=scales::label_percent()) +
  theme_bw() +
  theme(axis.title = element_text(face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(face="bold")) +
  facet_wrap(~Sex, nrow=3)
age.fig.sex


pdf(file = here::here("outputs", "figures", "San Juan chinook age composition 2012-present.pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

age.fig.sex

dev.off()
```

<br>

#### Size-at-age of hatchery fish

```{r size-at-age, fig.cap='Size at age by sex of San Juan Chinook broodstock. Note differing y axes for adults vs. jacks. For some years we used the linear relationship between FL and POH to infill for missing POH lengths.'}
# ggplot() + 
#   geom_point(data=sj.biodata %>% 
#                filter(Sex!="Jill", !is.na(`(R) RESOLVED TOTAL AGE`)) %>%
#                group_by(`(R) SAMPLE YEAR`, `(R) RESOLVED TOTAL AGE`, Sex) %>%
#                mutate_at("POH Length (mm)", as.numeric) %>%
#                mutate_at("Fork Length (mm)", as.numeric) %>%
#                summarize(meanPOH = mean(`POH Length (mm)`, na.rm=T),
#                          meanFL = mean(`Fork Length (mm)`, na.rm=T)), 
#              aes(x=`(R) SAMPLE YEAR`, y=meanPOH, fill=as.factor(`(R) RESOLVED TOTAL AGE`), colour=as.factor(`(R) RESOLVED TOTAL AGE`)),
#              shape=21) +
#   facet_wrap(~Sex, nrow=3)

size.age.fig <-
ggplot() +
  geom_boxplot(data=sj.biodata %>% 
               filter(Sex!="Jill", !is.na(`(R) RESOLVED TOTAL AGE`), grepl("san juan", `(R) RESOLVED STOCK ID`, ignore.case=T)), 
             aes(x=`(R) SAMPLE YEAR`, y=`POH Length (mm)`, 
                 fill=as.factor(`(R) RESOLVED TOTAL AGE`), colour=as.factor(`(R) RESOLVED TOTAL AGE`)),
             alpha=0.7, size=1, width=0.5) +
  labs(fill="Age:  ", colour="Age:  ",  x="Brood year") +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=15),
        axis.title = element_text(face="bold", size=17),
        #axis.title.x = element_blank(),
        strip.text = element_text(size=14),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.key.spacing.x = unit(8, "mm")) +
  facet_wrap(~Sex, nrow=3, scales="free_y")
size.age.fig


pdf(file = here::here("outputs", "figures", "San Juan chinook size-at-age 2012-present.pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

size.age.fig

dev.off()
```








```{r}
# STUDY DESIGN TABLE
study_design_year <- 2024

SJ_allAgesMaster %>% 
  mutate(species = case_when(grepl("chinook", PADS_Species, ignore.case=T) ~ "Chinook",
                             grepl("coho", PADS_Species, ignore.case=T) ~ "Coho",
                             grepl("chum", PADS_Species, ignore.case=T) ~ "Chum")) %>%
  # mutate(full_series = "group1",
  #        recent_4yr = case_when(`(R) SAMPLE YEAR` %in% seq(study_design_year-4, study_design_year, by=1) ~ "recent_4yr",
  #                           TRUE ~ NA),
  #        recent_12yr = case_when(`(R) SAMPLE YEAR` %in% seq(study_design_year-12, study_design_year, by=1) ~ "recent_12yr",
  #                           TRUE ~ NA)) %>% 

  filter(!is.na(`(R) RESOLVED TOTAL AGE`), `(R) RESOLVED TOTAL AGE`%in%c("1","2","3","4","5","6"), !grepl("M", PADS_GrAge)) %>% 
  group_by(species, `(R) SAMPLE YEAR`, `PADS_GrAge`) %>% 
  summarize(n_age = n()) %>% 
  group_by(species, `(R) SAMPLE YEAR`) %>% 
  mutate(year_total = sum(n_age),
         age_propn = n_age/year_total) %>% 
  mutate(group = "1",
         group = case_when(`(R) SAMPLE YEAR` %in% seq(study_design_year-12, study_design_year, by=1) ~ paste0(group, ", 2"),
                           TRUE ~ group),
         group = case_when(`(R) SAMPLE YEAR` %in% seq(study_design_year-4, study_design_year, by=1) ~ paste0(group, ", 3"),
                           TRUE ~ group)) %>% 
  group_by(species, group, `PADS_GrAge`) %>% 
  summarize(avg_age_propn = mean(age_propn))
```


<br>

```{r age-fishery-fig, echo=F, warning=F, message=F, fig.cap='Annual age structure of San Juan Chinook (excludes tributaries). Numbers indicate the number of samples contributing age data each year. Data from PADS (NuSEDS and MRPIS).', eval=F}
# FIGURE: AGE ~ FISHERY ----------------------- 
# ggplot() +
#   geom_bar(data=sj.FULL.age %>% 
#          filter(!is.na(`(R) RESOLVED TOTAL AGE`), `Sample Year` %in% c(2005, 2014, 2015)) %>%
#          group_by(`Sample Year`, Fishery, `(R) RESOLVED TOTAL AGE`) %>% 
#          summarize(n=n()) %>% 
#          group_by(`Sample Year`, Fishery) %>% 
#          mutate(sample_size = sum(n),
#                 propn=n/sum(n)),
#        aes(x=Fishery, y=propn, fill=as.factor(`(R) RESOLVED TOTAL AGE`), colour=as.factor(`(R) RESOLVED TOTAL AGE`)), 
#        stat="identity", position="stack", width=0.5, alpha=0.8, size=1) +
#   geom_text(data=sj.FULL.age %>% 
#               filter(!is.na(`(R) RESOLVED TOTAL AGE`), `Sample Year` %in% c(2005, 2014, 2015)) %>% 
#               group_by(`Sample Year`, Fishery) %>% summarize(sample_size = n()), 
#             aes(x=Fishery, y=1, label=sample_size), hjust=0, vjust=0, angle=45) +
#   labs(y="Proportion of annual biosamples by fishery", fill="Age:", colour="Age:") +
#   scale_y_continuous(breaks=seq(0,1.1,by=0.25), limits=c(0,1.1), labels=scales::label_percent()) +
#   theme_bw() +
#   theme(axis.text = element_text(colour="black", size=11),
#         axis.text.x = element_text(angle=45, hjust=1),
#         axis.title = element_text(face="bold", size=13),
#         axis.title.x = element_blank(),
#         legend.position = "bottom",
#         legend.direction = "horizontal",
#         legend.title = element_text(face="bold"),
#         plot.caption = element_text(face="italic", hjust=0)) +
#   facet_wrap(~`Sample Year`)
```

<br>

### Natural spawner age composition 

So far the only deadpitch data available are from 2024. 





<br>

## Sex ratio and fecundity

Very little sex ratio is available. We have some fence counts that may shed light, although are highly uncertain. Notice that the fence typically handles more males earlier in the run. 

```{r}
sj.fence %>% 
  filter(species=="chinook", sex%in%c("M","F", "J"), disposition%in%c("kept for brood", "released upstream", "retained or released")) %>%
  group_by(year, method, sex) %>%
  summarize(n=sum(count)) %>%
  group_by(year, method) %>% 
  mutate(propn=round(n/sum(n),3),
         n=sum(n)) %>%
  #select(-c(n)) %>% 
  pivot_wider(names_from = sex, values_from = propn) %>% 
  rename(`Total chinook counted`=n, `Female (%)`=F, `Male (%)`=M) %>% 
  kbl(align="c", caption="Sex ratio of chinook passing by the San Juan fence or handled in broodstock seines/tangle nets. Data from 4 Mile Hatchery.") %>%
  #collapse_rows(columns=c(1,2), valign="middle", target=1) %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center")
```

<br>

There is also very little fecundity data available, and all is bulk/annual averages from the hatchery.

```{r}
sj.fecund %>% 
  group_by(Year) %>%
  summarize(mean_fec = round(mean(Fecundity),0), sd=round(sd(Fecundity),0),
            n_females = sum(Number_females)) %>%
  mutate(across(c(mean_fec:n_females), ~ format(.x, big.mark = ","))) %>% 
  rename(`Mean fecundity`=mean_fec, `# females in sample`=n_females) %>%
  kbl(align="c", caption="Fecundity of San Juan Chinook with variance and sample size where available. Data from 4 Mile Hatchery.") %>%
  #collapse_rows(columns=c(1,2), valign="middle", target=1) %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center")
```

<br>

There is currently no estimate of natural female spawner success.
