---
title: "WCVI Fisheries Summary (CREST)"
output: html_document
date: '2024-04-13'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, echo=F, message=F)

# Load libraries ------------------------------------
library(tidyverse)


# Helpers ------------------------------------
"%notin%" <- Negate("%in%")





# ================================= MRP CWT Recovery data =================================

# MRP DUMP ------------------------------------
  # source(here::here("scripts", "functions", "pullA20ChinookCWTRelRcvy.R"))
  # saves as a20cwtRcvy
a20cwtRcvy <- readxl::read_excel(here::here("outputs", "R_OUT - Area 20 CWT Recoveries JOIN Releases - CHINOOK RY1982-2022.xlsx"), 
                                 sheet=1)

# Fishery mapping ------------------------------------
FisheryGearMapping <- readxl::read_excel(here::here("data", "fisheries", "MRP-RMPC - Fishery Gear Mapping.xlsx"), sheet=1)



# ================================= Spatial data =================================

# DFO PFMA spatial files -----------------------
DFOcentroids <- read.csv(here::here("data", "fisheries", "spatial", "MRP_PFMA_spatial.csv")) %>%
  rename(`R (RC) Recovery PSC Location-L4`=PFMA_resolved)

pfmaPOLY <- rgdal::readOGR(dsn=here::here("data", "fisheries", "spatial"), layer="pfma1", verbose=F)
wcviPFMApoly <- pfmaPOLY[pfmaPOLY@data$STATAREA%in%c(20:27,121:127),]
pfma_sf <- sf::st_read(dsn=here::here("data", "fisheries", "spatial"), layer="pfma1")

creelSubAreaPOLY <- rgdal::readOGR(dsn=here::here("data", "fisheries", "spatial"), layer="Creel_Survey_Areas", verbose=F)
creelSubAreaPOLY_sf <- sf::st_read(dsn=here::here("data", "fisheries", "spatial"), layer="Creel_Survey_Areas")
creelSubAreaPOLY_sf <- sf::st_as_sf(x = creelSubAreaPOLY_sf,                         
                  coords = c("longitude", "latitude"),
                  crs = "+proj=utm +zone=10")
sfc = sf::st_transform(creelSubAreaPOLY_sf, crs = "+proj=longlat +datum=WGS84")
creelSubAreaPOLY_sfdf <- as.data.frame(sfc)
  
# Load "UScentroids" -----------------------
#source(here("scripts", "misc-helpers", "UScentroidCompile.R"))


# Area 20 fishing locations
a20_rec_locations <- readxl::read_excel(path=here::here("data", "fisheries", "Area 20 rec fishing lat longs.xlsx"),
                                        sheet=1)

# ================================= JOIN MRP + FISHERY-GEAR + SPATIAL data =================================
# 
# a20cwtRcvy.spatial <- left_join(
#   a20cwtRcvy %>% 
#     mutate(`R (RC) Recovery PSC Location-L4` = case_when(`(RC) Reporting Agency Code`=="CDFO" ~ 
#                                                            str_remove(str_sub(`(RC) Recovery PSC Location-L4`,2,4), "^0+"),
#                                                          TRUE ~ `(RC) Recovery PSC Location-L4`)),
#   # 1. Join to DFO points
#   DFOcentroids %>%
#     select(`R (RC) Recovery PSC Location-L4`, lat, long) %>%
#     mutate(`(RC) Reporting Agency Code` = "CDFO"),
#   by=c("(RC) Reporting Agency Code", "R (RC) Recovery PSC Location-L4"),
#   na_matches="never") %>%
#   
#   #2. Join to US points
#   left_join(.,
#             UScentroids, 
#             by=c("(RC) Reporting Agency Code", "R (RC) Recovery PSC Location-L4")) %>%
#   mutate(lat = case_when(is.na(lat) ~ as.numeric(X2) , 
#                          TRUE ~ lat),
#          long = case_when(is.na(long) ~ as.numeric(X1),
#                           TRUE ~ long)) %>% 
#   
#   # 3. Join to Fishery mapping codes
#   left_join(.,
#             FisheryGearMapping %>% 
#               mutate(across(everything(), as.character)),
#             by=c( "(RC) Fishery PSC Code", "(RC) Gear PSC Code")) %>%
#   print()
# 
# 
# # ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ Remove temp file clutter ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
# rm(list = c('DFOcentroids', 'a20cwtRcvy', "FisheryGearMapping", "UScentroids"))
# 



# ================================= CREST RAW DATA LOAD =================================

# Biodata w results ----------------------
WCVIcrestBDWR <- #readxl::read_xlsx(path=list.files(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/CHINOOK/WCVI_TERMINAL_RUN/Annual_data_summaries_for_RunRecons/CREST-BDWRcompile_base-files/2-Export-from-R/",
  #                                    pattern="^R_OUT - Biological_Data_with_Results AND TERM GROUPINGS",  
  #                                    #\\(.*\\) \\d{4}-\\d{4}\\.csv$
  #                                    full.names=T), 
  #                    sheet=2, guess_max=50000) %>%
  read.csv(file=list.files(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/CHINOOK/WCVI_TERMINAL_RUN/Annual_data_summaries_for_RunRecons/CREST-BDWRcompile_base-files/2-Export-from-R/",
                           pattern="^R_OUT - Biological_Data_with_Results AND TERM GROUPINGS \\d{4}-\\d{4}\\.csv$",  
                           #
                           full.names=T)) %>%
  janitor::clean_names() %>%
  mutate(yday = lubridate::yday(collection_date),
         LEGAL_STATUS = case_when(length_mm > 450 & length_mm < 800 ~ "LEGAL",
                                  length_mm <= 450 ~ "SUBLEGAL",
                                  length_mm >= 800 & yday%in%c(196:212) ~ "SUPERLEGAL",
                                  length_mm >= 800 & yday%notin%c(196:212) ~ "LEGAL",
                                  is.na(length_mm) ~ "LEGAL"),     #assume legal if not measured
         # isSJ1 = case_when(grepl("San Juan", x_r_term_sum, ignore.case=T) ~ x_r_term_sum,
         #                   !grepl("San Juan", x_r_term_sum, ignore.case=T) & x_r_origin!="Unknown" ~ 
         #                     paste0(x_r_origin, " ", "Non-San Juan"),
         #                   !grepl("San Juan", x_r_term_sum, ignore.case=T) & x_r_origin=="Unknown" ~ 
         #                     "Unknown Non-San Juan"),
         # isSJ2 = case_when(grepl("Non-San Juan", isSJ1, ignore.case=T) ~ "Other",
         #                   TRUE ~ isSJ1)
         is_sj = case_when(grepl("san juan", x_r_term_sum, ignore.case=T) ~ "San Juan origin",
                           TRUE ~ "Other")
         ) %>% 
  print()





# Catch estimates ----------------------
catEst <- readxl::read_excel(path="//ent.dfo-mpo.ca/DFO-MPO/GROUP/PAC/Reg_Shares/FHM/SMCS/Salmon/FMCR_Fishery_Monitoring_Catch_Reporting/Recreational_CM/Catch_Data/SC Sport Catch Creel Sub-area Disposition (Master Do Not Edit).xlsx", 
                             sheet="YTD") %>%
  filter(grepl("127|27|126|26|125|25|124|24|123|23|121|21|22|20", PFMA), YEAR>=2017, SPECIES=="CHINOOK SALMON") 



# ================================= JOIN CATCH ESTIMATES TO BIODATA =================================

# BY YEAR, MONTH AND AREA ------------------------
SJ_stockcomp_WCVI_YMA <- left_join(WCVIcrestBDWR %>% 
                                       mutate_at("area", as.character) %>% 
                                       mutate(SUBAREAfocal = case_when(area=="20" ~ subarea,
                                                                       TRUE ~ area)) %>% 
                                       filter(sample_type=="Sport", species==124, disposition=="Kept", LEGAL_STATUS=="LEGAL") %>% 
                                       group_by(year, month, area, is_sj) %>% 
                                       summarize(n = n()) %>%
                                       # mutate(isSJ3 = case_when(isSJ2=="Other" ~ isSJ2,
                                       #                          TRUE ~ "San Juan origin")) %>%
                                       group_by(year, month, area) %>%
                                       mutate(total_catch_month = sum(n),
                                              proportion_is_sj = case_when(grepl("San Juan", is_sj, 
                                                                                 ignore.case=T) ~ n/total_catch_month,
                                                                           TRUE ~ NA)), 
                                     
                                     catEst %>% 
                                       rename(AREA=PFMA) %>% 
                                       mutate(AREA = str_sub(AREA, start=6, end=9)) %>%
                                       group_by(YEAR, AREA, MONTH, DISPOSITION) %>% 
                                       summarize(Est = sum(ESTIMATE, na.rm=T),
                                                 SE = sum(STANDARD_ERROR,na.rm=T)) %>% 
                                       pivot_wider(names_from=DISPOSITION, values_from=c(Est, SE)) %>%
                                       select(YEAR, AREA, MONTH, Est_Kept, `Est_Released Legal`),
                                     
                                     by=c("year"="YEAR", "month"="MONTH", "area"="AREA")) %>%
  full_join(data.frame(area=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20")),
            .,
            by="area") %>%
  janitor::clean_names() %>%
  mutate(est_n_SJ_kept = proportion_is_sj*est_kept)


# Joined to spatial data (did this in a separate DF because once you join you can't View in RStudio easily) ----
SJ_stockcomp_WCVI_YMA_spatial <- left_join(pfma_sf, 
                                           SJ_stockcomp_WCVI_YMA %>%
                                             mutate_at("area", as.character) %>%
                                             mutate_at("area", as.integer),
                                           by=c("STATAREA" = "area"))




# BY YEAR, MONTH AND SUBAREA ------------------------
SJ_stockcomp_WCVI_YMSA <- left_join(WCVIcrestBDWR %>% 
                                       mutate_at("area", as.character) %>% 
                                       mutate(SUBAREAfocal = case_when(area=="20" ~ subarea,
                                                                       TRUE ~ area)) %>% 
                                       filter(sample_type=="Sport", species==124, disposition=="Kept", LEGAL_STATUS=="LEGAL") %>% 
                                       group_by(year, month, area, subarea, is_sj) %>% 
                                       summarize(n = n()) %>%
                                       # mutate(isSJ3 = case_when(isSJ2=="Other" ~ isSJ2,
                                       #                          TRUE ~ "San Juan origin")) %>%
                                       group_by(year, month, area, subarea) %>%
                                       mutate(total_catch_month = sum(n),
                                              proportion_is_sj = case_when(grepl("San Juan", is_sj, 
                                                                                 ignore.case=T) ~ n/total_catch_month,
                                                                           TRUE ~ NA)), 
                                     
                                     catEst %>% 
                                       rename(AREA=PFMA) %>% 
                                       mutate(AREA = str_sub(AREA, start=6, end=9)) %>%
                                       group_by(YEAR, MONTH, AREA, CREEL_SUB_AREA, DISPOSITION) %>% 
                                       summarize(Est = sum(ESTIMATE, na.rm=T),
                                                 SE = sum(STANDARD_ERROR,na.rm=T)) %>% 
                                       pivot_wider(names_from=DISPOSITION, values_from=c(Est, SE)) %>%
                                       select(YEAR, AREA, MONTH, Est_Kept, `Est_Released Legal`),
                                     
                                     by=c("year"="YEAR", "month"="MONTH", "area"="AREA", "subarea"="CREEL_SUB_AREA")) %>%
  # full_join(data.frame(area=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20")),
  #           .,
  #           by="area") %>%
  janitor::clean_names() %>%
  mutate(est_n_SJ_kept = proportion_is_sj*est_kept)


# Joined to spatial data (did this in a separate DF because once you join you can't View in RStudio easily) ----
SJ_stockcomp_WCVI_YMSA_spatial <- left_join(pfma_sf, 
                                           SJ_stockcomp_WCVI_YMSA %>%
                                             mutate_at("area", as.character) %>%
                                             mutate_at("area", as.integer),
                                           by=c("STATAREA" = "area"))





# Join to PFMA spatial data ------------------
# wcviPFMA_sjCatEst <- left_join(pfma_sf ,
#                                WCVIcrestBDWR.catEst.sj %>% 
#                                  group_by(year, month, area, is_sj3) %>% 
#                                  summarize(n_lvl3 = sum(n, na.rm=T),
#                                            est_kept = unique(est_kept),
#                                            est_released_legal = unique(est_released_legal))  %>%
#                                  group_by(year, month, area) %>% 
#                                  mutate(AreaMonthTotalSamples = sum(n_lvl3, na.rm=T),
#                                         propn_AreaMonth = n_lvl3/AreaMonthTotalSamples,
#                                         estKeptByID = propn_AreaMonth*est_kept,
#                                         # i think i did this "inverse" for some reason due to mapping  but i can't remember: 
#                                         inverse_estKeptByID = case_when(is_sj3=="Other" ~ est_kept-estKeptByID,
#                                                                         TRUE ~ estKeptByID),
#                                         inverse_estKeptByID = case_when(inverse_estKeptByID==0 ~ NA,
#                                                                         TRUE ~ inverse_estKeptByID)) %>%
#                                  filter(!is.na(year),
#                                         !(is_sj3=="Other" & propn_AreaMonth<1 & estKeptByID!=inverse_estKeptByID)) %>%
#                                  ungroup() %>%
#                                  full_join(data.frame(area=c("127", "27", "126", "26", "125", "25", "124", "24", 
#                                                              "123", "23", "121", "22", "21", "20")) %>%
#                                              mutate(year=rep(2023, nrow(.)),
#                                                     month=rep("May", nrow(.))),
#                                            .,
#                                            by=c("year", "month", "area")) %>%
#                                  complete(.,year,month,area) %>% 
#                                  rename(statarea=area) %>%
#                                  ungroup() %>%
#                                  mutate_at("statarea", as.character) %>%
#                                  mutate_at("statarea", as.integer), #%>%
#                                #select(STATAREA, MONTH, AreaPropnMonthlySamples, estKeptByID) %>%
#                                #pivot_wider(names_from = MONTH, values_from = c(AreaPropnMonthlySamples, estKeptByID)),
#                                by=c("STATAREA"="statarea"))
```





## **WCVI Sport Fishery**

<br>

### Assumptions and caveats to using CREST Biodata

Definitions of natural, hatchery and unknown origin Chinook:

- A fish is assumed Natural origin if an otolith is returned as "Not Marked" and the adipose fin is intact. PBT is not currently considered as it is stock/facility-specific, and would likely only apply to very recent RYs (2022/2023). 
  + This assumption may not be appropriate in cases where hatchery fish are not thermally marked AND have no other identifier (probably rare? Perhaps US?).
  + Intact adipose fins *alone* are NOT evidence of a natural fish, and are considered "Unknown" origin (see below)
- A fish is Hatchery origin if it has an adipose clip, a thermal mark, a CWT, and/or a PBT BY assignment (in recent years).
  + Note there are some rare cases of wild-tagging programs in Yukon/Alaska, but these are not expected to show up in great numbers for Chinook. 
- A fish is Unknown origin if it has an intact adipose and no other mark or tag to inform further, e.g., destroyed or missing otolith, missing or lost tag, no  samples analyzed, etc.) 
- Stock ID is assigned in order of reliability: CWT > PBT > Otolith > GSI

<br>

The following caveats/assumptions must be taken into consideration when interpreting the recreational fishery data presented below:

- A genetic stock ID is only included if it has >= 75% certainty.
- It is assumed that biosampling is representative of kept catch, but this varies year to year as sample sizes are low. 
- Biosamples represent kept, legal catch and therefore do not represent the portions of populations <45cm or >80cm
  + Only legal sized Chinook are included here (> 45cm). Extra-legal (aka Super-legal) Chinook (>80cm) have also been excluded as current regs exclude these fish from the fishery.
- **No corrections are done to account for thermal mark issues from any facility in any given year. Missing  thermal marks would show up as "Not Marked" and bias results towards reporting more natural-origin Chinook than may in fact exist.**
- No GSI results are available prior to 2020 in Area 21/121. 
- Considerable changes to the recreational fishery along SWVI came into effect around 2018-2019 so comparisons across these years should be careful. 
- Unknown stock IDs were excluded from the following analyses. Results are expressed as regional population IDs as a proportion of known samples. 

<br>

**Please keep in mind sample rates for these areas are below ideal levels, so conclusions drawn should be very careful. Please read the last section that lays out the sample rates (i.e., % of kept catch sampled) by month and year!"**

<br>

<br>


```{r include=F, eval=F}

# DELETE THIS BLOCK SOON 
# Helpers for graphing ------------------
# avg_catch_area$AREA <- factor(avg_catch_area$AREA, levels=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20", ordered=T))
# WCVIcrestBDWR.catEst.sj$AREA <- factor(WCVIcrestBDWR.catEst.sj$AREA, levels=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20", ordered=T))
# WCVIcrestBDWR.catEst.sj$MONTH <- factor(WCVIcrestBDWR.catEst.sj$MONTH, levels=month.name)
# WCVIcrestBDWR.catEst.sj$MONTH <- factor(WCVIcrestBDWR.catEst.sj$MONTH, levels=month.name)
# 
# 
# ggplot() +
#   geom_boxplot(data=WCVIcrestBDWR.catEst.sj%>%filter(isSJ2!="Other"),
#                aes(x=MONTH, y=estKeptByID, group=interaction(MONTH,isSJ2), fill=isSJ2, colour=isSJ2), 
#                position=position_dodge(width=0.75), width=0.7, size=1, alpha=0.6) +
#   geom_text(data=avg_catch_area, 
#             aes(x=MONTH, y=0, group=interaction(MONTH,isSJ2), label=paste0("n=", round(meann,1)), colour=isSJ2, fontface="italic"),
#             position=position_dodge(width=0.7), size=4) +
#   expand_limits(y=0) +
#   labs(x="", y="Approximate number of kept, legal San Juan Chinook by strata", fill="", colour="", tag="No corrections have been made to natural origin fish \nto account for missing BY thermal marks.") +
#   facet_wrap(~AREA, scales="free") +
#   theme_bw() +
#   theme(axis.title = element_text(face="bold", size=10),
#         axis.text = element_text(size=8),
#         legend.position = c(0.8,0.2),
#         plot.tag.position = c(0.75,0.15),
#         plot.tag = element_text(colour="red", hjust=0))





# # CWTs
# cwt_by_area <- a20cwtRcvy.spatial %>% 
#   filter(`(RC) Recovery Year`>=2017,  `(RC) Fishery PSC Code`==40) %>%
#   group_by(`(RC) Recovery Year`, `(RC) Recovery Month`, `(RC) Recovery PSC Location-L3`) %>%
#   summarize(total_obs = sum(`(RC) Observed Number`), lat=lat, long=long) %>%
#   filter(!is.na(lat)) %>%
#   mutate(`(RC) Recovery Month` = lubridate::month(`(RC) Recovery Month`, label = T, abbr = F)) %>%
#   print()









# # Join to spatial
 # WCVIcrestBDWR.catEst.sj.spatial <- sp::merge(x=pfmaPOLY, 
 #                                   y=WCVIcrestBDWR.catEst.sj %>%
 #                                       filter(isSJ2!="Other", YEAR==2022, MONTH=="July") %>%
 #                                       ungroup() %>%
 #                                       select(AREA, AreaPropnMonthlySamples, estKeptByID),
 #                        by.x="STATAREA", by.y="AREA", duplicateGeoms=T)



```




```{r eval=F, include=F}
#SAVING FOR LEAFLET MAP CODE REFERENCE BUT OLD NO LONGER NEEDED


# pal <- colorNumeric("BuYlRd", na.color = "transparent", c(0.01,400)) # forgot the arguments here
# 
# leaflet() %>% 
#   # 1. Structure BASEMAP: 
#   
#   #addProviderTiles(providers$Stamen.TerrainBackground) %>%
#   #addProviderTiles(providers$CartoDB.VoyagerNoLabels) %>%
#   #addProviderTiles(providers$OpenStreetMap.HOT) %>%
#   #addProviderTiles(providers$Esri.WorldImagery) %>%
#   
#   addProviderTiles(providers$Esri.OceanBasemap) %>%
#   addWMSTiles(
#     "https://gis.ngdc.noaa.gov/arcgis/services/graticule/MapServer/WMSServer/",
#     layers = c("1-degree grid", "5-degree grid"),
#     options = WMSTileOptions(format = "image/png8", transparent = TRUE),
#     attribution = NULL,group = 'Graticules') %>%
#   setView(lng=-125.686921, lat= 49.534798, zoom=7) %>%
#   hideGroup(c('Place names')) %>%
# 
#   
#   #3. Add WCVI PFMAs coloured by # kept 
#   addPolygons(data = wcvitt,
#               stroke=T, fillOpacity=0.2, smoothFactor=0.5, weight=1, fill=T, fillColor=~pal(wcvitt$estKeptByID)) %>%
#   addLegend(
#     pal = pal,
#     values = wcvitt$estKeptByID,
#     position = 'topright')
#   
#   
#   
#   
#   addCircleMarkers(data=a20cwtRcvy.spatial %>% filter(!is.na(lat)) %>%
#                      group_by(lat,long) %>% summarize(totalExp = sum(`(RC) Expanded Number`)),
#                    lat= ~lat,
#                    lng = ~long,
#                    radius=~ifelse(totalExp<10, 1.5,
#                                   ifelse(totalExp>=120 & 
#                                            totalExp <50, 3,
#                                          ifelse(totalExp >= 50, 5, 7))),
#                    color=~"purple", stroke=F, fillOpacity=0.8) 
```




### WCVI: San Juan catch across all WCVI PFMAs (27-20 and offshore) 

Proportion of legal sized biosamples that return as San Juan in each Area applied to kept, legal catch estimates for 2017-2023 (note 2023 biodata still incomplete). 

<br>

#### All San Juan-origin across WCVI

Applying stock comp %s from creel biosamples to estimated catch by Month/Area/Year. Note 2023 is incomplete as of April 2024, and 2017-2019 lacked GSI sampling to resolve unmarked San Juan (i.e., if no thermal mark or CWT, San Juan fish would not have been detectable). 2020 onward stock ID includes otolith thermal marks, CWTs, PBT (complete BYs as of 2023 return year; PBT started BY2018), and GSI, although note not all BYs were marked completely, see https://github.com/khdavidson/A20/blob/main/outputs/R_OUT%20-%20San%20Juan%20mark%20history%20by%20BROOD%20YEAR.xlsx. 

```{r fig.height='100%', fig.width='100%'}
# Helpers for graphing ------------------
# WCVIcrestBDWR.catEst.sj$AREA <- factor(WCVIcrestBDWR.catEst.sj$AREA, levels=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20", ordered=T))
# WCVIcrestBDWR.catEst.sj$MONTH <- factor(WCVIcrestBDWR.catEst.sj$MONTH, levels=month.name)
# 
# ggplot(data = WCVIcrestBDWR.catEst.sj %>% filter(isSJ3!="Other")) +
#   geom_point(aes(x=AREA, y=MONTH, fill=AreaPropnMonthlySamples, colour=AreaPropnMonthlySamples), shape=22, size=5) +
#   theme_bw() +
#   facet_wrap(~YEAR, ncol=1, strip.position = "right")  


# Heatmap of all WCVI San Juan catch estimates all years ------------------  DELETE SOON 
# #plotly::ggplotly(
#   ggplot(data = 
#            # WCVIcrestBDWR.catEst.sj %>% 
#              # group_by(year, month, area, is_sj3) %>% 
#              # summarize(n_lvl3 = sum(n, na.rm=T),
#              #           est_kept = unique(est_kept),
#              #           est_released_legal = unique(est_released_legal))  %>%
#              # group_by(year, month, area) %>% 
#              # mutate(areamonthTotalSamples = sum(n_lvl3, na.rm=T),
#              #        propn_areamonth = n_lvl3/areamonthTotalSamples,
#              #        estKeptByID = propn_areamonth*est_kept,
#              #        inverse_estKeptByID = case_when(is_sj3=="Other" ~ est_kept-estKeptByID,
#              #                                        TRUE ~ estKeptByID),
#              #        inverse_estKeptByID = case_when(inverse_estKeptByID==0 ~ NA,
#              #                                       TRUE ~ inverse_estKeptByID) %>%
#              # filter(!is.na(year),
#              #        !(is_sj3=="Other" & propn_areamonth<1 & estKeptByID!=inverse_estKeptByID)) %>%
#              # ungroup() %>%
#              # full_join(data.frame(area=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21",
#              #                             "20")) %>%
#              #             mutate(year=rep(2023, nrow(.)),
#              #                    month=rep("May", nrow(.))),
#              #           .,
#              #           by=c("year", "month", "area")) %>%
#              # complete(.,year,month,area)
# 
#            SJ_stockcomp_WCVI_YMA %>%
#            mutate(n_SJ_in_samples = case_when(is_sj3=="San Juan origin" ~ n,
#                                               TRUE ~ NA)) %>%
#            filter(!is.na(year))) +
#     # geom_ribbon(data = WCVIcrestBDWR.catEst.sj %>% 
#     #               filter(year%in%c(2017:2019)),
#     #             aes(ymin="127", ymax="20", x=factor(month, levels=month.name)),
#     #             fill="gray80", colour="gray80", alpha=0.2, size=40) +
#     # geom_ribbon(data = WCVIcrestBDWR.catEst.sj %>% 
#     #               filter(year%in%c(2023)),
#     #             aes(ymin="127", ymax="20", x=factor(month, levels=month.name)),
#     #             fill="red", colour="red", alpha=0.1, size=40) +
#     geom_point(aes(y=area, x=month, fill=est_n_SJ_kept, colour=est_n_SJ_kept, 
#                    text=paste("Estimated # kept=", round(est_n_SJ_kept,0), "\nBased on # confirmed biosamples, n=", n_SJ_in_samples)), 
#                shape=22, size=2.5, alpha=0.8) +
#     scale_fill_binned(breaks=seq(0,1000,by=100), type="viridis", na.value="pink") +
#     scale_colour_binned(breaks=seq(0,1000,by=100), type="viridis", na.value="red") +
#     scale_x_discrete(limits = c("May", "June", "July", "August", "September")) +
#     scale_y_discrete(limits = rev(c("127", "27", "126", "26", "125", "25", "124", "24", "123", 
#                                     "23", "121", "22", "21", "20"))) +
#     labs(x="", y="area", fill="Estimated # Legal, Kept \nSan Juan-origin Chinook", 
#          colour="Estimated # Legal, Kept \nSan Juan-origin Chinook") +
#     theme_bw() +
#     facet_wrap(~year, ncol=2, strip.position = "right") + 
#     theme(axis.title = element_text(face="bold"),
#           legend.title = element_text(face="bold")) #,
#  # tooltip = c("area", "month", "text")
# #)


SJ_stockcomp_WCVI_YMA$month <- factor(SJ_stockcomp_WCVI_YMA$month, levels=c("May", "June", "July", "August", "September", ordered=T))
SJ_stockcomp_WCVI_YMA$area <- factor(SJ_stockcomp_WCVI_YMA$area, levels=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20", ordered=T))

ggplot(data=SJ_stockcomp_WCVI_YMA %>%
         mutate(n_SJ_in_samples = case_when(is_sj3=="San Juan origin" ~ n,
                                            TRUE ~ NA)) %>%
         filter(!is.na(year), !is.na(month), !is.na(est_n_SJ_kept))) +
  geom_tile(aes(y=area, x=month, fill=est_n_SJ_kept, colour=est_n_SJ_kept)) +
  scale_fill_viridis_b(na.value = "gray70") +
  scale_colour_viridis_b(na.value = "gray70") +
  scale_y_discrete(limits=rev) +
  labs(x="", y="Area", fill="Estimated number of kept \nSan Juan origin Chinook", 
       colour="Estimated number of kept \nSan Juan origin Chinook") +
  facet_wrap(~year) +
  theme_bw() +
  theme(legend.position = c(0.8, 0.15),
        axis.text = element_text(colour="black", size=15),
        axis.title = element_text(face="bold", size=17),
        legend.title = element_text(face="bold", size=16),
        legend.text = element_text(size=14),
        strip.text = element_text(size=12))
```

<br>

<br>

#### Annual monthly maps 

#### 2024 Catch estimate map

```{r }
# 2024 CATCH MAP

pdf(file = here::here("outputs", "figures", "WCVI SJ catch estimate map 2024.pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

ggplot() +
  geom_sf(data=SJ_stockcomp_WCVI_YMA_spatial %>% 
            sf::st_set_crs(.,"WGS84") %>% 
            filter(year=="2024") %>%
            filter(month%in%c("May", "June", "July", "August", "September")), 
          aes(fill=est_n_SJ_kept, text=paste0("PFMA ", STATAREA)), colour=alpha("gray60", 0.5), linewidth=0.5) +
  #scale_fill_viridis_b(na.value = NA) +
  paletteer::scale_fill_paletteer_c("viridis::plasma", na.value = NA) +
  geom_sf(data=rnaturalearth::ne_countries(type="countries", scale="large", returnclass="sf"), 
          colour="transparent", fill="black") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-129, -123), ylim=c(51.5, 48)) +
  labs(fill="Estimated number of kept \nSan Juan Chinook 2024") +
  theme_bw() +
  theme(axis.text = element_blank(),
        legend.title = element_text(face="bold", size=20),
        legend.text = element_text(size=19),
        legend.position = c(0.85, 0.2),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill="white"),
        strip.text = element_text(size=20),
        plot.title = element_text(size=15)) +
  facet_wrap(~factor(month, levels=c("May", "June", "July", "August", "September", ordered=T)))

dev.off()
```



<br>

<br>





















### Area 20: San Juan catch around Port Renfrew, by sub-area

```{r include=F}
# CREST biodata joined to catch ------------------------
# BY SUB-AREA 
# A20crestBDWR.catEst.sj <- left_join(WCVIcrestBDWR %>% 
#                                        mutate_at("area", as.character) %>% 
#                                        mutate(SUBAREAfocal = case_when(area=="20" ~ subarea,
#                                                                        TRUE ~ area)) %>% 
#                                        filter(sample_type=="Sport", species==124, disposition=="Kept", LEGAL_STATUS=="LEGAL",
#                                               area=="20") %>% 
#                                        group_by(year, month, subarea, isSJ2) %>% 
#                                        summarize(n = n()) %>%
#                                        mutate(is_sj3 = case_when(isSJ2=="Other" ~ isSJ2,
#                                                                 TRUE ~ "San Juan origin")), #%>%
#                                        # group_by(YEAR, MONTH, AREA, isSJ3) %>%
#                                        # mutate(n_lvl3 = sum(n_lvl2,na.rm=T)) %>% 
#                                       # group_by(YEAR, MONTH, AREA) %>%
#                                       # mutate(AreaMonthSampleTotal = sum(n_lvl2, na.rm=T),
#                                       #        AreaPropnMonthlySamples_lvl2 = n_lvl2/AreaMonthSampleTotal),
#                                      
#                                      catEst %>% 
#                                        rename(AREA=PFMA,
#                                               SUBAREA = CREEL_SUB_AREA) %>% 
#                                        mutate(AREA = str_sub(AREA, start=6, end=9)) %>%
#                                       filter(AREA=="20") %>%
#                                        group_by(YEAR, MONTH, SUBAREA, DISPOSITION) %>% 
#                                        summarize(Est = sum(ESTIMATE,na.rm=T),
#                                                  SE = sum(STANDARD_ERROR,na.rm=T)) %>% 
#                                        pivot_wider(names_from=DISPOSITION, values_from=c(Est, SE)) %>%
#                                        select(YEAR, MONTH, SUBAREA, Est_Kept, `Est_Released Legal`
#                                               #SE_Kept, `SE_Released Legal`,
#                                               #`Est_Released Sub-legal`, `SE_Released Sub-legal`
#                                               ),
#                                      
#                                      by=c("year"="YEAR", "month"="MONTH", "subarea"="SUBAREA")) %>% 
#   complete() %>%
#   janitor::clean_names()
# 
# 
# # Join to creel sub-areas --------------------
# A20subarea_sjCatEst <- left_join(creelSubAreaPOLY_sfdf %>%
#                                    mutate(CREELSUB = gsub(x=CREELSUB, pattern="-", replacement="")),
#                                  A20crestBDWR.catEst.sj %>%
#                                    group_by(year, month, subarea, is_sj3) %>% 
#                                    summarize(n_lvl3 = sum(n, na.rm=T),
#                                              est_kept = unique(est_kept),
#                                              est_released_legal = unique(est_released_legal))  %>%
#                                    group_by(year, month, subarea) %>% 
#                                    mutate(AreaMonthTotalSamples = sum(n_lvl3, na.rm=T),
#                                           propn_AreaMonth = n_lvl3/AreaMonthTotalSamples,
#                                           estKeptByID = propn_AreaMonth*est_kept,
#                                           inverse_estKeptByID = case_when(is_sj3=="Other" ~ est_kept-estKeptByID,
#                                                                           TRUE ~ estKeptByID),
#                                           inverse_estKeptByID = case_when(inverse_estKeptByID==0 ~ NA,
#                                                                           TRUE ~ inverse_estKeptByID)) %>%
#                                    filter(!is.na(year),
#                                           !(is_sj3=="Other" & propn_AreaMonth<1 & estKeptByID!=inverse_estKeptByID)) %>%
#                                    ungroup() %>%
#                                    # full_join(data.frame(AREA=c("127", "27", "126", "26", "125", "25", "124", "24", 
#                                    #                             "123", "23", "121", "22", "21", "20")) %>%
#                                    #             mutate(YEAR=rep(2023, nrow(.)),
#                                    #                    MONTH=rep("May", nrow(.))),
#                                    #           .,
#                                    #           by=c("YEAR", "MONTH", "AREA")) %>%
#                                    complete(.,year, month, subarea)  #%>% 
#                                    #rename(CREELSUB=subarea)
#                                  ,
#                                  by=c("CREELSUB"="subarea"))
```

```{r}
ggplot() +
  geom_sf(data=rnaturalearth::ne_countries(type="countries", scale="large", returnclass="sf"), 
          colour="transparent", fill="gray60",alpha=0.2) +
  geom_sf(data=A20subarea_sjCatEst%>%filter(year==2022) , aes(geometry=geometry, fill=inverse_estKeptByID), colour="black") + 
  
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", 
           xlim=c(-125, -123.5), ylim=c(48.8, 48.2)) +
  scale_fill_viridis_b(na.value = NA) +
  theme_bw() +
  facet_wrap(~factor(month, levels=c("May", "June", "July", "August", "September", ordered=T)))

 

```



```{r out.width='1300px', out.height='500px'}
SJ_stockcomp_WCVI_YMSA$month <- factor(SJ_stockcomp_WCVI_YMSA$month, levels=c("June", "July", "August", "September", ordered=T))
SJ_stockcomp_WCVI_YMSA$subarea <- factor(SJ_stockcomp_WCVI_YMSA$subarea, levels=c("20A", "20E", "20B", ordered=T))

ggplot(data=SJ_stockcomp_WCVI_YMSA %>%
         filter(subarea %in% c("20A", "20B", "20E"))%>%
         mutate(n_sj_in_sample = case_when(is_sj=="San Juan origin" ~ n,
                                           TRUE ~ NA))) +
  geom_tile(aes(x=month, y=subarea, fill=est_n_SJ_kept, colour=est_n_SJ_kept) ) +
  geom_text(aes(x=month, y=subarea, label = n_sj_in_sample), colour="white") +
  scale_fill_viridis_b(na.value = "gray70") +
  scale_colour_viridis_b(na.value = "gray70") +
  scale_y_discrete(limits=rev) +
  labs(x="", y="Creel sub-area", fill="Estimated number of kept \n San Juan-origin Chinook", colour="Estimated number of kept \n San Juan-origin Chinook") +
  facet_wrap(~year) +
  theme_bw() +
  theme(legend.position = c(0.8, 0.15),
        axis.text = element_text(colour="black", size=15),
        axis.title = element_text(face="bold", size=17),
        legend.title = element_text(face="bold", size=16),
        legend.text = element_text(size=14),
        strip.text = element_text(size=12))

```

<br>

```{r}
# Samples by fishing location in Area 20
sj_by_fishing_locations <- WCVIcrestBDWR %>%
  filter(subarea %in% c("20A", "20B", "20E"), is_sj=="San Juan origin") %>%
  group_by(year, month, is_sj, fishing_location) %>%
  summarize(n=n()) %>% 
  mutate(fishing_location2 = case_when(grepl("walbran|logan|cullite", fishing_location, ignore.case=T) ~ "Walbran to Cullite",
                                       grepl("camper|rockpile", fishing_location, ignore.case=T) ~ "Camper / Rockpile",
                                       grepl("owen", fishing_location, ignore.case=T) ~ "Owen Pt",
                                       grepl("bel buoy|can buoy", fishing_location, ignore.case=T) ~ "Bell Buoy",
                                       grepl("san juan point|east|botanical", fishing_location, ignore.case=T) ~ 
                                         "San Juan/East Pt/Botanical",
                                       grepl("wedge|port san juan/ bay", fishing_location, ignore.case=T) ~ "The Wedge",
                                       grepl("providence|sombrio", fishing_location, ignore.case=T) ~ "Providence/Sombrio",
                                       TRUE ~ fishing_location)) %>%
  group_by(year, month, is_sj, fishing_location2) %>%
  mutate(n2 = sum(n))

sj_by_fishing_locations$fishing_location2 <- factor(sj_by_fishing_locations$fishing_location2, levels=c("Walbran to Cullite", "Camper / Rockpile", "Owen Pt", "Bell Buoy", "The Wedge", "San Juan/East Pt/Botanical", "Providence/Sombrio", ordered=T))


sj_by_fishing_locations$month <- factor(sj_by_fishing_locations$month, levels=c("July", "August", ordered=T))
ggplot(data=sj_by_fishing_locations) +
  geom_tile(aes(x=month, y=fishing_location2, fill=n, colour=n)) +
  geom_text(aes(x=month, y=fishing_location2, label=n2), colour="white") +
  scale_y_discrete(limits=rev) +
  labs(x="", y="Fishing location", fill="Number of San Juan \nChinook in biosamples", 
       colour ="Number of San Juan \nChinook in biosamples") +
  facet_wrap(~year) +
  theme_bw() +
  theme(legend.position = c(0.8, 0.15),
        axis.text = element_text(colour="black", size=15),
        axis.title = element_text(face="bold", size=17),
        legend.title = element_text(face="bold", size=16),
        legend.text = element_text(size=14),
        strip.text = element_text(size=12))

```































<br>








